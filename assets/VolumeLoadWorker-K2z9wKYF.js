var Ir=Object.defineProperty;var _i=n=>{throw TypeError(n)};var Tr=(n,t,e)=>t in n?Ir(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var T=(n,t,e)=>Tr(n,typeof t!="symbol"?t+"":t,e),os=(n,t,e)=>t.has(n)||_i("Cannot "+e);var z=(n,t,e)=>(os(n,t,"read from private field"),e?e.call(n):t.get(n)),L=(n,t,e)=>t.has(n)?_i("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),k=(n,t,e,s)=>(os(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e),hs=(n,t,e)=>(os(n,t,"access private method"),e);const Cr=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map(n=>[n.name,n]),Qe=new Map(Cr);class Gs extends Error{constructor(e){super(Gs._prepareSuperMessage(e));T(this,"name","NonError")}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}}const Dr=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],Is=new WeakSet,kr=n=>{Is.add(n);const t=n.toJSON();return Is.delete(n),t},An=n=>Qe.get(n)??Error,Ys=({from:n,seen:t,to:e,forceEnumerable:s,maxDepth:i,depth:r,useToJSON:a,serialize:o})=>{if(!e)if(Array.isArray(n))e=[];else if(!o&&wi(n)){const l=An(n.name);e=new l}else e={};if(t.push(n),r>=i)return e;if(a&&typeof n.toJSON=="function"&&!Is.has(n))return kr(n);const h=l=>Ys({from:l,seen:[...t],forceEnumerable:s,maxDepth:i,depth:r,useToJSON:a,serialize:o});for(const[l,c]of Object.entries(n)){if(c&&c instanceof Uint8Array&&c.constructor.name==="Buffer"){e[l]="[object Buffer]";continue}if(c!==null&&typeof c=="object"&&typeof c.pipe=="function"){e[l]="[object Stream]";continue}if(typeof c!="function"){if(!c||typeof c!="object"){try{e[l]=c}catch{}continue}if(!t.includes(n[l])){r++,e[l]=h(n[l]);continue}e[l]="[Circular]"}}for(const{property:l,enumerable:c}of Dr)typeof n[l]<"u"&&n[l]!==null&&Object.defineProperty(e,l,{value:wi(n[l])?h(n[l]):n[l],enumerable:s?!0:c,configurable:!0,writable:!0});return e};function Rr(n,t={}){const{maxDepth:e=Number.POSITIVE_INFINITY,useToJSON:s=!0}=t;return typeof n=="object"&&n!==null?Ys({from:n,seen:[],forceEnumerable:!0,maxDepth:e,depth:0,useToJSON:s,serialize:!0}):typeof n=="function"?`[Function: ${n.name||"anonymous"}]`:n}function Or(n,t={}){const{maxDepth:e=Number.POSITIVE_INFINITY}=t;if(n instanceof Error)return n;if(Lr(n)){const s=An(n.name);return Ys({from:n,seen:[],to:new s,maxDepth:e,depth:0,serialize:!1})}return new Gs(n)}function wi(n){return!!n&&typeof n=="object"&&"name"in n&&"message"in n&&"stack"in n}function Lr(n){return!!n&&typeof n=="object"&&"message"in n&&!Array.isArray(n)}const Mn=n=>n.data!==void 0,vr=({data:n})=>Array.isArray(n)?n.length:n.byteLength,bi=n=>n.byteLength??vr(n),Pr=25e7;class Nr{constructor(t=Pr){this.entries=new Map,this.maxSize=t,this.currentSize=0,this.first=null,this.last=null}get size(){return this.currentSize}get numberOfEntries(){return this.entries.size}removeEntryFromStore(t){this.entries.delete(t.key),this.currentSize-=bi(t.data)}removeEntryFromList(t){const{prev:e,next:s}=t;e?e.next=s:this.first=s,s?s.prev=e:this.last=e}addEntryAsFirst(t){this.first?this.first.prev=t:this.last=t,t.next=this.first,t.prev=null,this.first=t}moveEntryToFirst(t){t!==this.first&&(this.removeEntryFromList(t),this.addEntryAsFirst(t))}evictLast(){if(!this.last){console.error("VolumeCache: attempt to evict last entry from cache when no last entry is set");return}this.removeEntryFromStore(this.last),this.last.prev&&(this.last.prev.next=null),this.last=this.last.prev}evict(t){this.removeEntryFromStore(t),this.removeEntryFromList(t)}insert(t,e){const s=bi(e);if(s>this.maxSize)return console.error("VolumeCache: attempt to insert a single entry larger than the cache"),!1;const i=this.getEntry(t);if(i!==void 0)return i.data=e,!0;const r={data:e,prev:null,next:null,key:t};for(this.addEntryAsFirst(r),this.entries.set(t,r),this.currentSize+=s;this.currentSize>this.maxSize;)this.evictLast();return!0}getEntry(t){const e=this.entries.get(t);return e&&this.moveEntryToFirst(e),e}get(t){var e;return(e=this.getEntry(t))==null?void 0:e.data}clearWithPrefix(t){for(const[e,s]of this.entries.entries())e.startsWith(t)&&this.evict(s)}clear(){for(;this.last;)this.evictLast()}}/**
 * @license
 * Copyright 2010-2024 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const zn="171",$s=300,Si=1e3,Gt=1001,Ai=1002,Ke=1003,En=1006,Ur=1008,je=1009,Fr=1010,Br=1011,qr=1012,Vr=1013,Gr=1014,Yr=1015,In=1023,$r=1024,Xr=1028,kt=1029,jr="",De=2e3,Mi=2001;class Tn{addEventListener(t,e){this._listeners===void 0&&(this._listeners={});const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){if(this._listeners===void 0)return!1;const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){if(this._listeners===void 0)return;const i=this._listeners[t];if(i!==void 0){const r=i.indexOf(e);r!==-1&&i.splice(r,1)}}dispatchEvent(t){if(this._listeners===void 0)return;const s=this._listeners[t.type];if(s!==void 0){t.target=this;const i=s.slice(0);for(let r=0,a=i.length;r<a;r++)i[r].call(this,t);t.target=null}}}const U=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function Xs(){const n=Math.random()*4294967295|0,t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return(U[n&255]+U[n>>8&255]+U[n>>16&255]+U[n>>24&255]+"-"+U[t&255]+U[t>>8&255]+"-"+U[t>>16&15|64]+U[t>>24&255]+"-"+U[e&63|128]+U[e>>8&255]+"-"+U[e>>16&255]+U[e>>24&255]+U[s&255]+U[s>>8&255]+U[s>>16&255]+U[s>>24&255]).toLowerCase()}function O(n,t,e){return Math.max(t,Math.min(e,n))}class Mt{constructor(t=0,e=0){Mt.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6],this.y=i[1]*e+i[4]*s+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=O(this.x,t.x,e.x),this.y=O(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=O(this.x,t,e),this.y=O(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(O(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(O(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),i=Math.sin(e),r=this.x-t.x,a=this.y-t.y;return this.x=r*s-a*i+t.x,this.y=r*i+a*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class ze{constructor(t,e,s,i,r,a,o,h,l){ze.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],t!==void 0&&this.set(t,e,s,i,r,a,o,h,l)}set(t,e,s,i,r,a,o,h,l){const c=this.elements;return c[0]=t,c[1]=i,c[2]=o,c[3]=e,c[4]=r,c[5]=h,c[6]=s,c[7]=a,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,a=s[0],o=s[3],h=s[6],l=s[1],c=s[4],u=s[7],d=s[2],f=s[5],m=s[8],y=i[0],p=i[3],g=i[6],x=i[1],_=i[4],S=i[7],w=i[2],A=i[5],M=i[8];return r[0]=a*y+o*x+h*w,r[3]=a*p+o*_+h*A,r[6]=a*g+o*S+h*M,r[1]=l*y+c*x+u*w,r[4]=l*p+c*_+u*A,r[7]=l*g+c*S+u*M,r[2]=d*y+f*x+m*w,r[5]=d*p+f*_+m*A,r[8]=d*g+f*S+m*M,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8];return e*a*c-e*o*l-s*r*c+s*o*h+i*r*l-i*a*h}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=c*a-o*l,d=o*h-c*r,f=l*r-a*h,m=e*u+s*d+i*f;if(m===0)return this.set(0,0,0,0,0,0,0,0,0);const y=1/m;return t[0]=u*y,t[1]=(i*l-c*s)*y,t[2]=(o*s-i*a)*y,t[3]=d*y,t[4]=(c*e-i*h)*y,t[5]=(i*r-o*e)*y,t[6]=f*y,t[7]=(s*h-l*e)*y,t[8]=(a*e-s*r)*y,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,r,a,o){const h=Math.cos(r),l=Math.sin(r);return this.set(s*h,s*l,-s*(h*a+l*o)+a+t,-i*l,i*h,-i*(-l*a+h*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(ls.makeScale(t,e)),this}rotate(t){return this.premultiply(ls.makeRotation(-t)),this}translate(t,e){return this.premultiply(ls.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let i=0;i<9;i++)if(e[i]!==s[i])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return new this.constructor().fromArray(this.elements)}}const ls=new ze;function zi(n){return document.createElementNS("http://www.w3.org/1999/xhtml",n)}function cs(n){return n<.04045?n*.0773993808:Math.pow(n*.9478672986+.0521327014,2.4)}let Rt;class Hr{static getDataURL(t){if(/^data:/i.test(t.src)||typeof HTMLCanvasElement>"u")return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{Rt===void 0&&(Rt=zi("canvas")),Rt.width=t.width,Rt.height=t.height;const s=Rt.getContext("2d");t instanceof ImageData?s.putImageData(t,0,0):s.drawImage(t,0,0,t.width,t.height),e=Rt}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap){const e=zi("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const i=s.getImageData(0,0,t.width,t.height),r=i.data;for(let a=0;a<r.length;a++)r[a]=cs(r[a]/255)*255;return s.putImageData(i,0,0),e}else if(t.data){const e=t.data.slice(0);for(let s=0;s<e.length;s++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[s]=Math.floor(cs(e[s]/255)*255):e[s]=cs(e[s]);return{data:e,width:t.width,height:t.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let Zr=0;class Kr{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Zr++}),this.uuid=Xs(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){t===!0&&this.version++}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.images[this.uuid]!==void 0)return t.images[this.uuid];const s={uuid:this.uuid,url:""},i=this.data;if(i!==null){let r;if(Array.isArray(i)){r=[];for(let a=0,o=i.length;a<o;a++)i[a].isDataTexture?r.push(us(i[a].image)):r.push(us(i[a]))}else r=us(i);s.url=r}return e||(t.images[this.uuid]=s),s}}function us(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&n instanceof ImageBitmap?Hr.getDataURL(n):n.data?{data:Array.from(n.data),width:n.width,height:n.height,type:n.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Wr=0;class xt extends Tn{constructor(t=xt.DEFAULT_IMAGE,e=xt.DEFAULT_MAPPING,s=Gt,i=Gt,r=En,a=Ur,o=In,h=je,l=xt.DEFAULT_ANISOTROPY,c=jr){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Wr++}),this.uuid=Xs(),this.name="",this.source=new Kr(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=i,this.magFilter=r,this.minFilter=a,this.anisotropy=l,this.format=o,this.internalFormat=null,this.type=h,this.offset=new Mt(0,0),this.repeat=new Mt(1,1),this.center=new Mt(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new ze,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.textures[this.uuid]!==void 0)return t.textures[this.uuid];const s={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==$s)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case Si:t.x=t.x-Math.floor(t.x);break;case Gt:t.x=t.x<0?0:1;break;case Ai:Math.abs(Math.floor(t.x)%2)===1?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x);break}if(t.y<0||t.y>1)switch(this.wrapT){case Si:t.y=t.y-Math.floor(t.y);break;case Gt:t.y=t.y<0?0:1;break;case Ai:Math.abs(Math.floor(t.y)%2)===1?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y);break}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){t===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){t===!0&&this.pmremVersion++}}xt.DEFAULT_IMAGE=null;xt.DEFAULT_MAPPING=$s;xt.DEFAULT_ANISOTROPY=1;class Ee{constructor(t=0,e=0,s=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=i}static slerpFlat(t,e,s,i,r,a,o){let h=s[i+0],l=s[i+1],c=s[i+2],u=s[i+3];const d=r[a+0],f=r[a+1],m=r[a+2],y=r[a+3];if(o===0){t[e+0]=h,t[e+1]=l,t[e+2]=c,t[e+3]=u;return}if(o===1){t[e+0]=d,t[e+1]=f,t[e+2]=m,t[e+3]=y;return}if(u!==y||h!==d||l!==f||c!==m){let p=1-o;const g=h*d+l*f+c*m+u*y,x=g>=0?1:-1,_=1-g*g;if(_>Number.EPSILON){const w=Math.sqrt(_),A=Math.atan2(w,g*x);p=Math.sin(p*A)/w,o=Math.sin(o*A)/w}const S=o*x;if(h=h*p+d*S,l=l*p+f*S,c=c*p+m*S,u=u*p+y*S,p===1-o){const w=1/Math.sqrt(h*h+l*l+c*c+u*u);h*=w,l*=w,c*=w,u*=w}}t[e]=h,t[e+1]=l,t[e+2]=c,t[e+3]=u}static multiplyQuaternionsFlat(t,e,s,i,r,a){const o=s[i],h=s[i+1],l=s[i+2],c=s[i+3],u=r[a],d=r[a+1],f=r[a+2],m=r[a+3];return t[e]=o*m+c*u+h*f-l*d,t[e+1]=h*m+c*d+l*u-o*f,t[e+2]=l*m+c*f+o*d-h*u,t[e+3]=c*m-o*u-h*d-l*f,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,i=t._y,r=t._z,a=t._order,o=Math.cos,h=Math.sin,l=o(s/2),c=o(i/2),u=o(r/2),d=h(s/2),f=h(i/2),m=h(r/2);switch(a){case"XYZ":this._x=d*c*u+l*f*m,this._y=l*f*u-d*c*m,this._z=l*c*m+d*f*u,this._w=l*c*u-d*f*m;break;case"YXZ":this._x=d*c*u+l*f*m,this._y=l*f*u-d*c*m,this._z=l*c*m-d*f*u,this._w=l*c*u+d*f*m;break;case"ZXY":this._x=d*c*u-l*f*m,this._y=l*f*u+d*c*m,this._z=l*c*m+d*f*u,this._w=l*c*u-d*f*m;break;case"ZYX":this._x=d*c*u-l*f*m,this._y=l*f*u+d*c*m,this._z=l*c*m-d*f*u,this._w=l*c*u+d*f*m;break;case"YZX":this._x=d*c*u+l*f*m,this._y=l*f*u+d*c*m,this._z=l*c*m-d*f*u,this._w=l*c*u-d*f*m;break;case"XZY":this._x=d*c*u-l*f*m,this._y=l*f*u-d*c*m,this._z=l*c*m+d*f*u,this._w=l*c*u+d*f*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return e===!0&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],r=e[8],a=e[1],o=e[5],h=e[9],l=e[2],c=e[6],u=e[10],d=s+o+u;if(d>0){const f=.5/Math.sqrt(d+1);this._w=.25/f,this._x=(c-h)*f,this._y=(r-l)*f,this._z=(a-i)*f}else if(s>o&&s>u){const f=2*Math.sqrt(1+s-o-u);this._w=(c-h)/f,this._x=.25*f,this._y=(i+a)/f,this._z=(r+l)/f}else if(o>u){const f=2*Math.sqrt(1+o-s-u);this._w=(r-l)/f,this._x=(i+a)/f,this._y=.25*f,this._z=(h+c)/f}else{const f=2*Math.sqrt(1+u-s-o);this._w=(a-i)/f,this._x=(r+l)/f,this._y=(h+c)/f,this._z=.25*f}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<Number.EPSILON?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(O(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(s===0)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return t===0?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,r=t._z,a=t._w,o=e._x,h=e._y,l=e._z,c=e._w;return this._x=s*c+a*o+i*l-r*h,this._y=i*c+a*h+r*o-s*l,this._z=r*c+a*l+s*h-i*o,this._w=a*c-s*o-i*h-r*l,this._onChangeCallback(),this}slerp(t,e){if(e===0)return this;if(e===1)return this.copy(t);const s=this._x,i=this._y,r=this._z,a=this._w;let o=a*t._w+s*t._x+i*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=a,this._x=s,this._y=i,this._z=r,this;const h=1-o*o;if(h<=Number.EPSILON){const f=1-e;return this._w=f*a+e*this._w,this._x=f*s+e*this._x,this._y=f*i+e*this._y,this._z=f*r+e*this._z,this.normalize(),this}const l=Math.sqrt(h),c=Math.atan2(l,o),u=Math.sin((1-e)*c)/l,d=Math.sin(e*c)/l;return this._w=a*u+this._w*d,this._x=s*u+this._x*d,this._y=i*u+this._y*d,this._z=r*u+this._z*d,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(i*Math.sin(t),i*Math.cos(t),r*Math.sin(e),r*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class b{constructor(t=0,e=0,s=0){b.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return s===void 0&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(Ei.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Ei.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*i,this.y=r[1]*e+r[4]*s+r[7]*i,this.z=r[2]*e+r[5]*s+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,a=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*a,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*a,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*a,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,r=t.x,a=t.y,o=t.z,h=t.w,l=2*(a*i-o*s),c=2*(o*e-r*i),u=2*(r*s-a*e);return this.x=e+h*l+a*u-o*c,this.y=s+h*c+o*l-r*u,this.z=i+h*u+r*c-a*l,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=O(this.x,t.x,e.x),this.y=O(this.y,t.y,e.y),this.z=O(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=O(this.x,t,e),this.y=O(this.y,t,e),this.z=O(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(O(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,a=e.x,o=e.y,h=e.z;return this.x=i*h-r*o,this.y=r*a-s*h,this.z=s*o-i*a,this}projectOnVector(t){const e=t.lengthSq();if(e===0)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return fs.copy(this).projectOnVector(t),this.sub(fs)}reflect(t){return this.sub(fs.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(O(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,e*4)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,e*3)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=Math.random()*2-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const fs=new b,Ei=new Ee;class it{constructor(t=new b(1/0,1/0,1/0),e=new b(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(H.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(H.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=H.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return new this.constructor().copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(s!==void 0){const r=s.getAttribute("position");if(e===!0&&r!==void 0&&t.isInstancedMesh!==!0)for(let a=0,o=r.count;a<o;a++)t.isMesh===!0?t.getVertexPosition(a,H):H.fromBufferAttribute(r,a),H.applyMatrix4(t.matrixWorld),this.expandByPoint(H);else t.boundingBox!==void 0?(t.boundingBox===null&&t.computeBoundingBox(),ke.copy(t.boundingBox)):(s.boundingBox===null&&s.computeBoundingBox(),ke.copy(s.boundingBox)),ke.applyMatrix4(t.matrixWorld),this.union(ke)}const i=t.children;for(let r=0,a=i.length;r<a;r++)this.expandByObject(i[r],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,H),H.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(ie),Re.subVectors(this.max,ie),Ot.subVectors(t.a,ie),Lt.subVectors(t.b,ie),vt.subVectors(t.c,ie),ft.subVectors(Lt,Ot),dt.subVectors(vt,Lt),bt.subVectors(Ot,vt);let e=[0,-ft.z,ft.y,0,-dt.z,dt.y,0,-bt.z,bt.y,ft.z,0,-ft.x,dt.z,0,-dt.x,bt.z,0,-bt.x,-ft.y,ft.x,0,-dt.y,dt.x,0,-bt.y,bt.x,0];return!ds(e,Ot,Lt,vt,Re)||(e=[1,0,0,0,1,0,0,0,1],!ds(e,Ot,Lt,vt,Re))?!1:(Oe.crossVectors(ft,dt),e=[Oe.x,Oe.y,Oe.z],ds(e,Ot,Lt,vt,Re))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,H).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=this.getSize(H).length()*.5),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()?this:(rt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),rt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),rt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),rt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),rt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),rt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),rt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),rt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(rt),this)}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const rt=[new b,new b,new b,new b,new b,new b,new b,new b],H=new b,ke=new it,Ot=new b,Lt=new b,vt=new b,ft=new b,dt=new b,bt=new b,ie=new b,Re=new b,Oe=new b,St=new b;function ds(n,t,e,s,i){for(let r=0,a=n.length-3;r<=a;r+=3){St.fromArray(n,r);const o=i.x*Math.abs(St.x)+i.y*Math.abs(St.y)+i.z*Math.abs(St.z),h=t.dot(St),l=e.dot(St),c=s.dot(St);if(Math.max(-Math.max(h,l,c),Math.min(h,l,c))>o)return!1}return!0}class ht{constructor(t,e,s,i,r,a,o,h,l,c,u,d,f,m,y,p){ht.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t!==void 0&&this.set(t,e,s,i,r,a,o,h,l,c,u,d,f,m,y,p)}set(t,e,s,i,r,a,o,h,l,c,u,d,f,m,y,p){const g=this.elements;return g[0]=t,g[4]=e,g[8]=s,g[12]=i,g[1]=r,g[5]=a,g[9]=o,g[13]=h,g[2]=l,g[6]=c,g[10]=u,g[14]=d,g[3]=f,g[7]=m,g[11]=y,g[15]=p,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new ht().fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,i=1/Pt.setFromMatrixColumn(t,0).length(),r=1/Pt.setFromMatrixColumn(t,1).length(),a=1/Pt.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*a,e[9]=s[9]*a,e[10]=s[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,i=t.y,r=t.z,a=Math.cos(s),o=Math.sin(s),h=Math.cos(i),l=Math.sin(i),c=Math.cos(r),u=Math.sin(r);if(t.order==="XYZ"){const d=a*c,f=a*u,m=o*c,y=o*u;e[0]=h*c,e[4]=-h*u,e[8]=l,e[1]=f+m*l,e[5]=d-y*l,e[9]=-o*h,e[2]=y-d*l,e[6]=m+f*l,e[10]=a*h}else if(t.order==="YXZ"){const d=h*c,f=h*u,m=l*c,y=l*u;e[0]=d+y*o,e[4]=m*o-f,e[8]=a*l,e[1]=a*u,e[5]=a*c,e[9]=-o,e[2]=f*o-m,e[6]=y+d*o,e[10]=a*h}else if(t.order==="ZXY"){const d=h*c,f=h*u,m=l*c,y=l*u;e[0]=d-y*o,e[4]=-a*u,e[8]=m+f*o,e[1]=f+m*o,e[5]=a*c,e[9]=y-d*o,e[2]=-a*l,e[6]=o,e[10]=a*h}else if(t.order==="ZYX"){const d=a*c,f=a*u,m=o*c,y=o*u;e[0]=h*c,e[4]=m*l-f,e[8]=d*l+y,e[1]=h*u,e[5]=y*l+d,e[9]=f*l-m,e[2]=-l,e[6]=o*h,e[10]=a*h}else if(t.order==="YZX"){const d=a*h,f=a*l,m=o*h,y=o*l;e[0]=h*c,e[4]=y-d*u,e[8]=m*u+f,e[1]=u,e[5]=a*c,e[9]=-o*c,e[2]=-l*c,e[6]=f*u+m,e[10]=d-y*u}else if(t.order==="XZY"){const d=a*h,f=a*l,m=o*h,y=o*l;e[0]=h*c,e[4]=-u,e[8]=l*c,e[1]=d*u+y,e[5]=a*c,e[9]=f*u-m,e[2]=m*u-f,e[6]=o*c,e[10]=y*u+d}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Jr,t,Qr)}lookAt(t,e,s){const i=this.elements;return Y.subVectors(t,e),Y.lengthSq()===0&&(Y.z=1),Y.normalize(),mt.crossVectors(s,Y),mt.lengthSq()===0&&(Math.abs(s.z)===1?Y.x+=1e-4:Y.z+=1e-4,Y.normalize(),mt.crossVectors(s,Y)),mt.normalize(),Le.crossVectors(Y,mt),i[0]=mt.x,i[4]=Le.x,i[8]=Y.x,i[1]=mt.y,i[5]=Le.y,i[9]=Y.y,i[2]=mt.z,i[6]=Le.z,i[10]=Y.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,a=s[0],o=s[4],h=s[8],l=s[12],c=s[1],u=s[5],d=s[9],f=s[13],m=s[2],y=s[6],p=s[10],g=s[14],x=s[3],_=s[7],S=s[11],w=s[15],A=i[0],M=i[4],I=i[8],q=i[12],V=i[1],D=i[5],C=i[9],R=i[13],j=i[2],K=i[6],Tt=i[10],Ct=i[14],ut=i[3],W=i[7],nt=i[11],Dt=i[15];return r[0]=a*A+o*V+h*j+l*ut,r[4]=a*M+o*D+h*K+l*W,r[8]=a*I+o*C+h*Tt+l*nt,r[12]=a*q+o*R+h*Ct+l*Dt,r[1]=c*A+u*V+d*j+f*ut,r[5]=c*M+u*D+d*K+f*W,r[9]=c*I+u*C+d*Tt+f*nt,r[13]=c*q+u*R+d*Ct+f*Dt,r[2]=m*A+y*V+p*j+g*ut,r[6]=m*M+y*D+p*K+g*W,r[10]=m*I+y*C+p*Tt+g*nt,r[14]=m*q+y*R+p*Ct+g*Dt,r[3]=x*A+_*V+S*j+w*ut,r[7]=x*M+_*D+S*K+w*W,r[11]=x*I+_*C+S*Tt+w*nt,r[15]=x*q+_*R+S*Ct+w*Dt,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],r=t[12],a=t[1],o=t[5],h=t[9],l=t[13],c=t[2],u=t[6],d=t[10],f=t[14],m=t[3],y=t[7],p=t[11],g=t[15];return m*(+r*h*u-i*l*u-r*o*d+s*l*d+i*o*f-s*h*f)+y*(+e*h*f-e*l*d+r*a*d-i*a*f+i*l*c-r*h*c)+p*(+e*l*u-e*o*f-r*a*u+s*a*f+r*o*c-s*l*c)+g*(-i*o*c-e*h*u+e*o*d+i*a*u-s*a*d+s*h*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],f=t[11],m=t[12],y=t[13],p=t[14],g=t[15],x=u*p*l-y*d*l+y*h*f-o*p*f-u*h*g+o*d*g,_=m*d*l-c*p*l-m*h*f+a*p*f+c*h*g-a*d*g,S=c*y*l-m*u*l+m*o*f-a*y*f-c*o*g+a*u*g,w=m*u*h-c*y*h-m*o*d+a*y*d+c*o*p-a*u*p,A=e*x+s*_+i*S+r*w;if(A===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const M=1/A;return t[0]=x*M,t[1]=(y*d*r-u*p*r-y*i*f+s*p*f+u*i*g-s*d*g)*M,t[2]=(o*p*r-y*h*r+y*i*l-s*p*l-o*i*g+s*h*g)*M,t[3]=(u*h*r-o*d*r-u*i*l+s*d*l+o*i*f-s*h*f)*M,t[4]=_*M,t[5]=(c*p*r-m*d*r+m*i*f-e*p*f-c*i*g+e*d*g)*M,t[6]=(m*h*r-a*p*r-m*i*l+e*p*l+a*i*g-e*h*g)*M,t[7]=(a*d*r-c*h*r+c*i*l-e*d*l-a*i*f+e*h*f)*M,t[8]=S*M,t[9]=(m*u*r-c*y*r-m*s*f+e*y*f+c*s*g-e*u*g)*M,t[10]=(a*y*r-m*o*r+m*s*l-e*y*l-a*s*g+e*o*g)*M,t[11]=(c*o*r-a*u*r-c*s*l+e*u*l+a*s*f-e*o*f)*M,t[12]=w*M,t[13]=(c*y*i-m*u*i+m*s*d-e*y*d-c*s*p+e*u*p)*M,t[14]=(m*o*i-a*y*i-m*s*h+e*y*h+a*s*p-e*o*p)*M,t[15]=(a*u*i-c*o*i+c*s*h-e*u*h-a*s*d+e*o*d)*M,this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),r=1-s,a=t.x,o=t.y,h=t.z,l=r*a,c=r*o;return this.set(l*a+s,l*o-i*h,l*h+i*o,0,l*o+i*h,c*o+s,c*h-i*a,0,l*h-i*o,c*h+i*a,r*h*h+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,i,r,a){return this.set(1,s,r,0,t,1,a,0,e,i,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,r=e._x,a=e._y,o=e._z,h=e._w,l=r+r,c=a+a,u=o+o,d=r*l,f=r*c,m=r*u,y=a*c,p=a*u,g=o*u,x=h*l,_=h*c,S=h*u,w=s.x,A=s.y,M=s.z;return i[0]=(1-(y+g))*w,i[1]=(f+S)*w,i[2]=(m-_)*w,i[3]=0,i[4]=(f-S)*A,i[5]=(1-(d+g))*A,i[6]=(p+x)*A,i[7]=0,i[8]=(m+_)*M,i[9]=(p-x)*M,i[10]=(1-(d+y))*M,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;let r=Pt.set(i[0],i[1],i[2]).length();const a=Pt.set(i[4],i[5],i[6]).length(),o=Pt.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],Z.copy(this);const l=1/r,c=1/a,u=1/o;return Z.elements[0]*=l,Z.elements[1]*=l,Z.elements[2]*=l,Z.elements[4]*=c,Z.elements[5]*=c,Z.elements[6]*=c,Z.elements[8]*=u,Z.elements[9]*=u,Z.elements[10]*=u,e.setFromRotationMatrix(Z),s.x=r,s.y=a,s.z=o,this}makePerspective(t,e,s,i,r,a,o=De){const h=this.elements,l=2*r/(e-t),c=2*r/(s-i),u=(e+t)/(e-t),d=(s+i)/(s-i);let f,m;if(o===De)f=-(a+r)/(a-r),m=-2*a*r/(a-r);else if(o===Mi)f=-a/(a-r),m=-a*r/(a-r);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return h[0]=l,h[4]=0,h[8]=u,h[12]=0,h[1]=0,h[5]=c,h[9]=d,h[13]=0,h[2]=0,h[6]=0,h[10]=f,h[14]=m,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,i,r,a,o=De){const h=this.elements,l=1/(e-t),c=1/(s-i),u=1/(a-r),d=(e+t)*l,f=(s+i)*c;let m,y;if(o===De)m=(a+r)*u,y=-2*u;else if(o===Mi)m=r*u,y=-1*u;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return h[0]=2*l,h[4]=0,h[8]=0,h[12]=-d,h[1]=0,h[5]=2*c,h[9]=0,h[13]=-f,h[2]=0,h[6]=0,h[10]=y,h[14]=-m,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let i=0;i<16;i++)if(e[i]!==s[i])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const Pt=new b,Z=new ht,Jr=new b(0,0,0),Qr=new b(1,1,1),mt=new b,Le=new b,Y=new b,Ii=new ht,Ti=new Ee;class ts{constructor(t=0,e=0,s=0,i=ts.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,i=this._order){return this._x=t,this._y=e,this._z=s,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const i=t.elements,r=i[0],a=i[4],o=i[8],h=i[1],l=i[5],c=i[9],u=i[2],d=i[6],f=i[10];switch(e){case"XYZ":this._y=Math.asin(O(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,f),this._z=Math.atan2(-a,r)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-O(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,f),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(O(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,f),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(h,r));break;case"ZYX":this._y=Math.asin(-O(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,f),this._z=Math.atan2(h,r)):(this._x=0,this._z=Math.atan2(-a,l));break;case"YZX":this._z=Math.asin(O(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(o,f));break;case"XZY":this._z=Math.asin(-O(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-c,f),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,s===!0&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return Ii.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Ii,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return Ti.setFromEuler(this),this.setFromQuaternion(Ti,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],t[3]!==void 0&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}ts.DEFAULT_ORDER="XYZ";class ta{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return(this.mask&t.mask)!==0}isEnabled(t){return(this.mask&(1<<t|0))!==0}}let ea=0;const Ci=new b,Nt=new Ee,at=new ht,ve=new b,ne=new b,sa=new b,ia=new Ee,Di=new b(1,0,0),ki=new b(0,1,0),Ri=new b(0,0,1),Oi={type:"added"},na={type:"removed"},Ut={type:"childadded",child:null},ms={type:"childremoved",child:null};class zt extends Tn{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:ea++}),this.uuid=Xs(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=zt.DEFAULT_UP.clone();const t=new b,e=new ts,s=new Ee,i=new b(1,1,1);function r(){s.setFromEuler(e,!1)}function a(){e.setFromQuaternion(s,void 0,!1)}e._onChange(r),s._onChange(a),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new ht},normalMatrix:{value:new ze}}),this.matrix=new ht,this.matrixWorld=new ht,this.matrixAutoUpdate=zt.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=zt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new ta,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Nt.setFromAxisAngle(t,e),this.quaternion.multiply(Nt),this}rotateOnWorldAxis(t,e){return Nt.setFromAxisAngle(t,e),this.quaternion.premultiply(Nt),this}rotateX(t){return this.rotateOnAxis(Di,t)}rotateY(t){return this.rotateOnAxis(ki,t)}rotateZ(t){return this.rotateOnAxis(Ri,t)}translateOnAxis(t,e){return Ci.copy(t).applyQuaternion(this.quaternion),this.position.add(Ci.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(Di,t)}translateY(t){return this.translateOnAxis(ki,t)}translateZ(t){return this.translateOnAxis(Ri,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(at.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?ve.copy(t):ve.set(t,e,s);const i=this.parent;this.updateWorldMatrix(!0,!1),ne.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?at.lookAt(ne,ve,this.up):at.lookAt(ve,ne,this.up),this.quaternion.setFromRotationMatrix(at),i&&(at.extractRotation(i.matrixWorld),Nt.setFromRotationMatrix(at),this.quaternion.premultiply(Nt.invert()))}add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(Oi),Ut.child=t,this.dispatchEvent(Ut),Ut.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let s=0;s<arguments.length;s++)this.remove(arguments[s]);return this}const e=this.children.indexOf(t);return e!==-1&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(na),ms.child=t,this.dispatchEvent(ms),ms.child=null),this}removeFromParent(){const t=this.parent;return t!==null&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),at.copy(this.matrixWorld).invert(),t.parent!==null&&(t.parent.updateWorldMatrix(!0,!1),at.multiply(t.parent.matrixWorld)),t.applyMatrix4(at),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(Oi),Ut.child=t,this.dispatchEvent(Ut),Ut.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,i=this.children.length;s<i;s++){const a=this.children[s].getObjectByProperty(t,e);if(a!==void 0)return a}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const i=this.children;for(let r=0,a=i.length;r<a;r++)i[r].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ne,t,sa),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ne,ia,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverse(t)}traverseVisible(t){if(this.visible===!1)return;t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;e!==null&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].updateMatrixWorld(t)}updateWorldMatrix(t,e){const s=this.parent;if(t===!0&&s!==null&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),e===!0){const i=this.children;for(let r=0,a=i.length;r<a;r++)i[r].updateWorldMatrix(!1,!0)}}toJSON(t){const e=t===void 0||typeof t=="string",s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.castShadow===!0&&(i.castShadow=!0),this.receiveShadow===!0&&(i.receiveShadow=!0),this.visible===!1&&(i.visible=!1),this.frustumCulled===!1&&(i.frustumCulled=!1),this.renderOrder!==0&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map(o=>({boxInitialized:o.boxInitialized,boxMin:o.box.min.toArray(),boxMax:o.box.max.toArray(),sphereInitialized:o.sphereInitialized,sphereRadius:o.sphere.radius,sphereCenter:o.sphere.center.toArray()})),i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(t),this._colorsTexture!==null&&(i.colorsTexture=this._colorsTexture.toJSON(t)),this.boundingSphere!==null&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),this.boundingBox!==null&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()}));function r(o,h){return o[h.uuid]===void 0&&(o[h.uuid]=h.toJSON(t)),h.uuid}if(this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const h=o.shapes;if(Array.isArray(h))for(let l=0,c=h.length;l<c;l++){const u=h[l];r(t.shapes,u)}else r(t.shapes,h)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(r(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let h=0,l=this.material.length;h<l;h++)o.push(r(t.materials,this.material[h]));i.material=o}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let o=0;o<this.children.length;o++)i.children.push(this.children[o].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let o=0;o<this.animations.length;o++){const h=this.animations[o];i.animations.push(r(t.animations,h))}}if(e){const o=a(t.geometries),h=a(t.materials),l=a(t.textures),c=a(t.images),u=a(t.shapes),d=a(t.skeletons),f=a(t.animations),m=a(t.nodes);o.length>0&&(s.geometries=o),h.length>0&&(s.materials=h),l.length>0&&(s.textures=l),c.length>0&&(s.images=c),u.length>0&&(s.shapes=u),d.length>0&&(s.skeletons=d),f.length>0&&(s.animations=f),m.length>0&&(s.nodes=m)}return s.object=i,s;function a(o){const h=[];for(const l in o){const c=o[l];delete c.metadata,h.push(c)}return h}}clone(t){return new this.constructor().copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),e===!0)for(let s=0;s<t.children.length;s++){const i=t.children[s];this.add(i.clone())}return this}}zt.DEFAULT_UP=new b(0,1,0);zt.DEFAULT_MATRIX_AUTO_UPDATE=!0;zt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;class ys extends xt{constructor(t=null,e=1,s=1,i,r,a,o,h,l=Ke,c=Ke,u,d){super(null,a,o,h,l,c,i,r,u,d),this.isDataTexture=!0,this.image={data:t,width:e,height:s},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:zn}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=zn);class lt extends Error{constructor(t,e={}){super(`Node not found: ${t}`,e),this.name="NodeNotFoundError"}}class Jt extends Error{constructor(t){super(`Missing key: ${t}`),this.name="KeyError"}}var X;class js{constructor(t,e,s){L(this,X);typeof t=="number"?k(this,X,new Uint8Array(t)):t instanceof ArrayBuffer?k(this,X,new Uint8Array(t,e,s)):k(this,X,new Uint8Array(Array.from(t,i=>i?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return z(this,X).byteOffset}get byteLength(){return z(this,X).byteLength}get buffer(){return z(this,X).buffer}get length(){return z(this,X).length}get(t){let e=z(this,X)[t];return typeof e=="number"?e!==0:e}set(t,e){z(this,X)[t]=e?1:0}fill(t){z(this,X).fill(t?1:0)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}X=new WeakMap;var Xt;class es{constructor(t,e,s,i){T(this,"_data");T(this,"chars");L(this,Xt);if(this.chars=t,k(this,Xt,new TextEncoder),typeof e=="number")this._data=new Uint8Array(e*t);else if(e instanceof ArrayBuffer)i&&(i=i*t),this._data=new Uint8Array(e,s,i);else{let r=Array.from(e);this._data=new Uint8Array(r.length*t);for(let a=0;a<r.length;a++)this.set(a,r[a])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(t){const e=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);return new TextDecoder().decode(e).replace(/\x00/g,"")}set(t,e){const s=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);s.fill(0),s.set(z(this,Xt).encode(e))}fill(t){const e=z(this,Xt).encode(t);for(let s=0;s<this.length;s++)this._data.set(e,s*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}Xt=new WeakMap;var F;const di=class di{constructor(t,e,s,i){L(this,F);T(this,"chars");if(this.chars=t,typeof e=="number")k(this,F,new Int32Array(e*t));else if(e instanceof ArrayBuffer)i&&(i*=t),k(this,F,new Int32Array(e,s,i));else{const r=e,a=new di(t,1);k(this,F,new Int32Array(function*(){for(let o of r)a.set(0,o),yield*z(a,F)}()))}}get BYTES_PER_ELEMENT(){return z(this,F).BYTES_PER_ELEMENT*this.chars}get byteLength(){return z(this,F).byteLength}get byteOffset(){return z(this,F).byteOffset}get buffer(){return z(this,F).buffer}get length(){return z(this,F).length/this.chars}get(t){const e=this.chars*t;let s="";for(let i=0;i<this.chars;i++)s+=String.fromCodePoint(z(this,F)[e+i]);return s.replace(/\u0000/g,"")}set(t,e){const s=this.chars*t,i=z(this,F).subarray(s,s+this.chars);i.fill(0);for(let r=0;r<this.chars;r++)i[r]=e.codePointAt(r)??0}fill(t){this.set(0,t);let e=z(this,F).subarray(0,this.chars);for(let s=1;s<this.length;s++)z(this,F).set(e,s*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}};F=new WeakMap;let Zt=di;function Hs(n){const t=JSON.stringify(n,null,2);return new TextEncoder().encode(t)}function It(n){const t=new TextDecoder().decode(n);return JSON.parse(t)}function Li(n,t){const e=t/2,s=t-1;let i=0;for(let r=0;r<n.length;r+=t)for(let a=0;a<e;a+=1)i=n[r+a],n[r+a]=n[r+s-a],n[r+s-a]=i}function Cn(n){if(n==="v2:object")return globalThis.Array;let t=n.match(/v2:([US])(\d+)/);if(t){let[,s,i]=t;return(s==="U"?Zt:es).bind(null,Number(i))}let e={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float16:globalThis.Float16Array,float32:Float32Array,float64:Float64Array,bool:js}[n];return v(e,`Unknown or unsupported data_type: ${n}`),e}function _t(n,t){const e=n.length;typeof t=="string"&&(t=t==="C"?Array.from({length:e},(r,a)=>a):Array.from({length:e},(r,a)=>e-1-a)),v(e===t.length,"Order length must match the number of dimensions.");let s=1,i=new Array(e);for(let r=t.length-1;r>=0;r--)i[t[r]]=s,s*=n[t[r]];return i}function ra({name:n,configuration:t}){if(n==="default"){const e=(t==null?void 0:t.separator)??"/";return s=>["c",...s].join(e)}if(n==="v2"){const e=(t==null?void 0:t.separator)??".";return s=>s.join(e)||"0"}throw new Error(`Unknown chunk key encoding: ${n}`)}function aa(n){if(n==="|O")return{data_type:"v2:object"};let t=n.match(/^([<|>])(.*)$/);v(t,`Invalid dtype: ${n}`);let[,e,s]=t,i={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f2:"float16",f4:"float32",f8:"float64"}[s]??(s.startsWith("S")||s.startsWith("U")?`v2:${s}`:void 0);return v(i,`Unsupported or unknown dtype: ${n}`),e==="|"?{data_type:i}:{data_type:i,endian:e==="<"?"little":"big"}}function oa(n,t={}){let e=[],s=aa(n.dtype);n.order==="F"&&e.push({name:"transpose",configuration:{order:"F"}}),"endian"in s&&s.endian==="big"&&e.push({name:"bytes",configuration:{endian:"big"}});for(let{id:i,...r}of n.filters??[])e.push({name:i,configuration:r});if(n.compressor){let{id:i,...r}=n.compressor;e.push({name:i,configuration:r})}return{zarr_format:3,node_type:"array",shape:n.shape,data_type:s.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:n.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:n.dimension_separator??"."}},codecs:e,fill_value:n.fill_value,attributes:t}}function ha(n,t={}){return{zarr_format:3,node_type:"group",attributes:t}}function la(n,t){if(t!=="number"&&t!=="bigint"&&t!=="boolean"&&t!=="object"&&t!=="string")return n===t;let e=n==="bool";if(t==="boolean")return e;let s=n.startsWith("v2:U")||n.startsWith("v2:S");if(t==="string")return s;let i=n==="int64"||n==="uint64";if(t==="bigint")return i;let r=n==="v2:object";return t==="object"?r:!s&&!i&&!e&&!r}function ca(n){return(n==null?void 0:n.name)==="sharding_indexed"}function Dn(n){return(n.data_type==="uint64"||n.data_type==="int64")&&n.fill_value!=null?BigInt(n.fill_value):n.fill_value}function Zs(n,...t){if(!t.some(e=>n instanceof e))throw n}function v(n,t=""){if(!n)throw new Error(t)}async function kn(n,{format:t,signal:e}){const s=n instanceof Response?n:new Response(n);v(s.body,"Response does not contain body.");try{return await new Response(s.body.pipeThrough(new DecompressionStream(t),{signal:e})).arrayBuffer()}catch{throw e==null||e.throwIfAborted(),new Error(`Failed to decode ${t}`)}}class Ks{constructor(t,e){T(this,"kind","array_to_array");v(t.keepbits>=0,"keepbits must be zero or positive")}static fromConfig(t,e){return new Ks(t,e)}encode(t){throw new Error("`BitroundCodec.encode` is not implemented. Please open an issue at https://github.com/manzt/zarrita.js/issues.")}decode(t){return t}}const vi=ua();function ua(){const n=new Uint32Array([305419896]);return new Uint8Array(n.buffer,n.byteOffset,n.byteLength)[0]!==18}function Pi(n){return"BYTES_PER_ELEMENT"in n?n.BYTES_PER_ELEMENT:4}var de,pt,me,ye,jt;const mi=class mi{constructor(t,e){T(this,"kind","array_to_bytes");L(this,de);L(this,pt);L(this,me);L(this,ye);L(this,jt);k(this,jt,t==null?void 0:t.endian),k(this,pt,Cn(e.data_type)),k(this,ye,e.shape),k(this,de,_t(e.shape,"C"));const s=new(z(this,pt))(0);k(this,me,s.BYTES_PER_ELEMENT)}static fromConfig(t,e){return new mi(t,e)}encode(t){let e=new Uint8Array(t.data.buffer);return vi&&z(this,jt)==="big"&&Li(e,Pi(z(this,pt))),e}decode(t){return vi&&z(this,jt)==="big"&&Li(t,Pi(z(this,pt))),{data:new(z(this,pt))(t.buffer,t.byteOffset,t.byteLength/z(this,me)),shape:z(this,ye),stride:z(this,de)}}};de=new WeakMap,pt=new WeakMap,me=new WeakMap,ye=new WeakMap,jt=new WeakMap;let We=mi;class Ws{constructor(){T(this,"kind","bytes_to_bytes")}static fromConfig(){return new Ws}encode(t){throw new Error("Not implemented")}decode(t){return new Uint8Array(t.buffer,t.byteOffset,t.byteLength-4)}}class Js{constructor(){T(this,"kind","bytes_to_bytes")}static fromConfig(t){return new Js}encode(t){throw new Error("Gzip encoding is not enabled by default. Please register a custom codec with `numcodecs/gzip`.")}async decode(t){const e=await kn(t,{format:"gzip"});return new Uint8Array(e)}}function fa(n,t){return v(!Number.isNaN(t),"JsonCodec allow_nan is false but NaN was encountered during encoding."),v(t!==Number.POSITIVE_INFINITY,"JsonCodec allow_nan is false but Infinity was encountered during encoding."),v(t!==Number.NEGATIVE_INFINITY,"JsonCodec allow_nan is false but -Infinity was encountered during encoding."),t}function da(n,t){return t instanceof Object&&!Array.isArray(t)?Object.keys(t).sort().reduce((e,s)=>(e[s]=t[s],e),{}):t}var pe,ge;const yi=class yi{constructor(t={}){T(this,"configuration");T(this,"kind","array_to_bytes");L(this,pe);L(this,ge);this.configuration=t;const{encoding:e="utf-8",skipkeys:s=!1,ensure_ascii:i=!0,check_circular:r=!0,allow_nan:a=!0,sort_keys:o=!0,indent:h,strict:l=!0}=t;let c=t.separators;c||(h?c=[", ",": "]:c=[",",":"]),k(this,pe,{encoding:e,skipkeys:s,ensure_ascii:i,check_circular:r,allow_nan:a,indent:h,separators:c,sort_keys:o}),k(this,ge,{strict:l})}static fromConfig(t){return new yi(t)}encode(t){const{indent:e,encoding:s,ensure_ascii:i,check_circular:r,allow_nan:a,sort_keys:o}=z(this,pe);v(s==="utf-8","JsonCodec does not yet support non-utf-8 encoding.");const h=[];v(r,"JsonCodec does not yet support skipping the check for circular references during encoding."),a||h.push(fa),o&&h.push(da);const l=Array.from(t.data);l.push("|O"),l.push(t.shape);let c;h.length&&(c=(d,f)=>{let m=f;for(let y of h)m=y(d,m);return m});let u=JSON.stringify(l,c,e);return i&&(u=u.replace(/[\u007F-\uFFFF]/g,d=>{const f=`0000${d.charCodeAt(0).toString(16)}`;return`\\u${f.substring(f.length-4)}`})),new TextEncoder().encode(u)}decode(t){const{strict:e}=z(this,ge);v(e,"JsonCodec does not yet support non-strict decoding.");const s=It(t),i=s.pop();s.pop(),v(i,"0D not implemented for JsonCodec.");const r=_t(i,"C");return{data:s,shape:i,stride:r}}};pe=new WeakMap,ge=new WeakMap;let Ts=yi;function Ni(n){return n instanceof js||n instanceof es||n instanceof Zt?new Proxy(n,{get(e,s){return e.get(Number(s))},set(e,s,i){return e.set(Number(s),i),!0}}):n}function ma(n,t){let e;return n.data instanceof es||n.data instanceof Zt?e=new n.constructor(n.data.length,n.data.chars):e=new n.constructor(n.data.length),{data:e,shape:n.shape,stride:_t(n.shape,t)}}function ya(n,t){let e=ma(n,t),s=n.shape.length,i=n.data.length,r=Array(s).fill(0),a=Ni(n.data),o=Ni(e.data);for(let h=0;h<i;h++){let l=0;for(let c=0;c<s;c++)l+=r[c]*e.stride[c];o[l]=a[h],r[0]+=1;for(let c=0;c<s;c++)if(r[c]===n.shape[c]){if(c+1===s)break;r[c]=0,r[c+1]+=1}}return e}function pa(n){let t=n.shape.length;return v(t===n.stride.length,"Shape and stride must have the same length."),n.stride.map((e,s)=>({stride:e,index:s})).sort((e,s)=>s.stride-e.stride).map(e=>e.index)}function ga(n,t){let e=pa(n);return v(e.length===t.length,"Orders must match"),e.every((s,i)=>s===t[i])}var xe,Ht;const pi=class pi{constructor(t,e){T(this,"kind","array_to_array");L(this,xe);L(this,Ht);let s=t.order??"C",i=e.shape.length,r=new Array(i),a=new Array(i);if(s==="C")for(let o=0;o<i;++o)r[o]=o,a[o]=o;else if(s==="F")for(let o=0;o<i;++o)r[o]=i-o-1,a[o]=i-o-1;else r=s,r.forEach((o,h)=>{v(a[o]===void 0,`Invalid permutation: ${JSON.stringify(s)}`),a[o]=h});k(this,xe,r),k(this,Ht,a)}static fromConfig(t,e){return new pi(t,e)}encode(t){return ga(t,z(this,Ht))?t:ya(t,z(this,Ht))}decode(t){return{data:t.data,shape:t.shape,stride:_t(t.shape,z(this,xe))}}};xe=new WeakMap,Ht=new WeakMap;let Cs=pi;var _e,we;const gi=class gi{constructor(t){T(this,"kind","array_to_bytes");L(this,_e);L(this,we);k(this,_e,t),k(this,we,_t(t,"C"))}static fromConfig(t,e){return new gi(e.shape)}encode(t){throw new Error("Method not implemented.")}decode(t){let e=new TextDecoder,s=new DataView(t.buffer),i=Array(s.getUint32(0,!0)),r=4;for(let a=0;a<i.length;a++){let o=s.getUint32(r,!0);r+=4,i[a]=e.decode(t.buffer.slice(r,r+o)),r+=o}return{data:i,shape:z(this,_e),stride:z(this,we)}}};_e=new WeakMap,we=new WeakMap;let Ds=gi;class Qs{constructor(){T(this,"kind","bytes_to_bytes")}static fromConfig(t){return new Qs}encode(t){throw new Error("Zlib encoding is not enabled by default. Please register a codec with `numcodecs/zlib`.")}async decode(t){const e=await kn(t,{format:"deflate"});return new Uint8Array(e)}}function xa(){return new Map().set("blosc",()=>import("./blosc-E49GQuAK.js").then(n=>n.default)).set("lz4",()=>import("./lz4-BIGKWw27.js").then(n=>n.default)).set("zstd",()=>import("./zstd-IvP746pw.js").then(n=>n.default)).set("gzip",()=>Js).set("zlib",()=>Qs).set("transpose",()=>Cs).set("bytes",()=>We).set("crc32c",()=>Ws).set("vlen-utf8",()=>Ds).set("json2",()=>Ts).set("bitround",()=>Ks)}const Rn=xa();function ks(n){let t;return{async encode(e){t||(t=await Ui(n));for(const i of t.array_to_array)e=await i.encode(e);let s=await t.array_to_bytes.encode(e);for(const i of t.bytes_to_bytes)s=await i.encode(s);return s},async decode(e){t||(t=await Ui(n));for(let i=t.bytes_to_bytes.length-1;i>=0;i--)e=await t.bytes_to_bytes[i].decode(e);let s=await t.array_to_bytes.decode(e);for(let i=t.array_to_array.length-1;i>=0;i--)s=await t.array_to_array[i].decode(s);return s}}}async function Ui(n){let t=n.codecs.map(async r=>{var o;let a=await((o=Rn.get(r.name))==null?void 0:o());return v(a,`Unknown codec: ${r.name}`),{Codec:a,meta:r}}),e=[],s,i=[];for await(let{Codec:r,meta:a}of t){let o=r.fromConfig(a.configuration,n);switch(o.kind){case"array_to_array":e.push(o);break;case"array_to_bytes":s=o;break;default:i.push(o)}}return s||(v(_a(n),`Cannot encode ${n.data_type} to bytes without a codec`),s=We.fromConfig({endian:"little"},n)),{array_to_array:e,array_to_bytes:s,bytes_to_bytes:i}}function _a(n){return n.data_type!=="v2:object"}const Fi=18446744073709551615n;function wa(n,t,e,s){v(n.store.getRange,"Store does not support range requests");let i=n.store.getRange.bind(n.store),r=t.map((h,l)=>h/s.chunk_shape[l]),a=ks({data_type:"uint64",shape:[...r,2],codecs:s.index_codecs}),o={};return async h=>{let l=h.map((x,_)=>Math.floor(x/r[_])),c=n.resolve(e(l)).path,u;if(c in o)u=o[c];else{let x=4,_=16*r.reduce((w,A)=>w*A,1),S=await i(c,{suffixLength:_+x});u=o[c]=S?await a.decode(S):null}if(u===null)return;let{data:d,shape:f,stride:m}=u,y=h.map((x,_)=>x%f[_]).reduce((x,_,S)=>x+_*m[S],0),p=d[y],g=d[y+1];if(!(p===Fi&&g===Fi))return i(c,{offset:Number(p),length:Number(g)})}}class ct{constructor(t,e="/"){T(this,"store");T(this,"path");this.store=t,this.path=e}resolve(t){let e=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new ct(this.store,new URL(t,e).pathname)}}function On(n){return new ct(n??new Map)}var be;class Ie extends ct{constructor(e,s,i){super(e,s);T(this,"kind","group");L(this,be);k(this,be,i)}get attrs(){return z(this,be).attributes}}be=new WeakMap;function Bi(n){var e;const t=n.find(s=>s.name==="transpose");return((e=t==null?void 0:t.configuration)==null?void 0:e.order)??"C"}const ae=Symbol("zarrita.context");function Ln(n){return n[ae]}function ba(n,t){let{configuration:e}=t.codecs.find(ca)??{},s={encode_chunk_key:ra(t.chunk_key_encoding),TypedArray:Cn(t.data_type),fill_value:t.fill_value};if(e){let r=Bi(e.codecs);return{...s,kind:"sharded",chunk_shape:e.chunk_shape,codec:ks({data_type:t.data_type,shape:e.chunk_shape,codecs:e.codecs}),get_strides(a){return _t(a,r)},get_chunk_bytes:wa(n,t.chunk_grid.configuration.chunk_shape,s.encode_chunk_key,e)}}let i=Bi(t.codecs);return{...s,kind:"regular",chunk_shape:t.chunk_grid.configuration.chunk_shape,codec:ks({data_type:t.data_type,shape:t.chunk_grid.configuration.chunk_shape,codecs:t.codecs}),get_strides(r){return _t(r,i)},async get_chunk_bytes(r,a){let o=s.encode_chunk_key(r),h=n.resolve(o).path;return n.store.get(h,a)}}}var wn,bn,At,Sn;let Kt=(Sn=class extends(bn=ct,wn=ae,bn){constructor(e,s,i){super(e,s);T(this,"kind","array");L(this,At);T(this,wn);k(this,At,{...i,fill_value:Dn(i)}),this[ae]=ba(this,i)}get attrs(){return z(this,At).attributes}get shape(){return z(this,At).shape}get chunks(){return this[ae].chunk_shape}get dtype(){return z(this,At).data_type}async getChunk(e,s){let i=this[ae],r=await i.get_chunk_bytes(e,s);if(!r){let a=i.chunk_shape.reduce((h,l)=>h*l,1),o=new i.TypedArray(a);return o.fill(i.fill_value),{data:o,shape:i.chunk_shape,stride:i.get_strides(i.chunk_shape)}}return i.codec.decode(r)}is(e){return la(this.dtype,e)}},At=new WeakMap,Sn),ss=Sa();function Sa(){let n=new WeakMap;function t(e){let s=n.get(e)??{v2:0,v3:0};return n.set(e,s),s}return{increment(e,s){t(e)[s]+=1},version_max(e){let s=t(e);return s.v3>s.v2?"v3":"v2"}}}async function Aa(n){let t=await n.store.get(n.resolve(".zattrs").path);return t?It(t):{}}async function Ma(n,t={}){let e="store"in n?n:new ct(n),s={};return(t.attrs??!0)&&(s=await Aa(e)),t.kind==="array"?qi(e,s):t.kind==="group"?Vi(e,s):qi(e,s).catch(i=>(Zs(i,lt),Vi(e,s)))}async function qi(n,t){let{path:e}=n.resolve(".zarray"),s=await n.store.get(e);if(!s)throw new lt("v2 array",{cause:new Jt(e)});return ss.increment(n.store,"v2"),new Kt(n.store,n.path,oa(It(s),t))}async function Vi(n,t){let{path:e}=n.resolve(".zgroup"),s=await n.store.get(e);if(!s)throw new lt("v2 group",{cause:new Jt(e)});return ss.increment(n.store,"v2"),new Ie(n.store,n.path,ha(It(s),t))}async function za(n){let{store:t,path:e}=n.resolve("zarr.json"),s=await n.store.get(e);if(!s)throw new lt("v3 array or group",{cause:new Jt(e)});let i=It(s);return i.node_type==="array"&&(i.fill_value=Dn(i)),i.node_type==="array"?new Kt(t,n.path,i):new Ie(t,n.path,i)}async function Ea(n,t={}){let e="store"in n?n:new ct(n),s=await za(e);if(ss.increment(e.store,"v3"),t.kind===void 0||t.kind==="array"&&s instanceof Kt||t.kind==="group"&&s instanceof Ie)return s;let i=s instanceof Kt?"array":"group";throw new Error(`Expected node of kind ${t.kind}, found ${i}.`)}async function ot(n,t={}){let e="store"in n?n.store:n,s=ss.version_max(e),i=s==="v2"?ot.v2:ot.v3,r=s==="v2"?ot.v3:ot.v2;return i(n,t).catch(a=>(Zs(a,lt),r(n,t)))}ot.v2=Ma;ot.v3=Ea;async function Ia(n,t={}){let e="store"in n?n:new ct(n);return"shape"in t?await Ca(e,t):Ta(e,t)}async function Ta(n,t={}){let e={zarr_format:3,node_type:"group",attributes:t.attributes??{}};return await n.store.set(n.resolve("zarr.json").path,Hs(e)),new Ie(n.store,n.path,e)}async function Ca(n,t){let e={zarr_format:3,node_type:"array",shape:t.shape,data_type:t.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:t.chunk_shape}},chunk_key_encoding:{name:"default",configuration:{separator:t.chunk_separator??"/"}},codecs:t.codecs??[],fill_value:t.fill_value??null,attributes:t.attributes??{}};return await n.store.set(n.resolve("zarr.json").path,Hs(e)),new Kt(n.store,n.path,e)}function*Da(n,t,e=1){t===void 0&&(t=n,n=0);for(let s=n;s<t;s+=e)yield s}function*ka(...n){if(n.length===0)return;const t=n.map(s=>s[Symbol.iterator]()),e=t.map(s=>s.next());if(e.some(s=>s.done))throw new Error("Input contains an empty iterator.");for(let s=0;;){if(e[s].done){if(t[s]=n[s][Symbol.iterator](),e[s]=t[s].next(),++s>=t.length)return}else yield e.map(({value:i})=>i),s=0;e[s]=t[s].next()}}function vn({start:n,stop:t,step:e},s){if(e===0)throw new Error("slice step cannot be zero");e=e??1;const i=e<0,[r,a]=i?[-1,s-1]:[0,s];return n===null?n=i?a:r:n<0?(n+=s,n<r&&(n=r)):n>a&&(n=a),t===null?t=i?r:a:t<0?(t+=s,t<r&&(t=r)):t>a&&(t=a),[n,t,e]}function Rs(n,t,e=null){return t===void 0&&(t=n,n=null),{start:n,stop:t,step:e}}function Pn(){const n=[];return{add:t=>n.push(t()),onIdle:()=>Promise.all(n)}}class is extends Error{constructor(t){super(t),this.name="IndexError"}}function Ra(n,t){throw new is(`too many indicies for array; expected ${t.length}, got ${n.length}`)}function Oa(n){throw new is(`index out of bounds for dimension with length ${n}`)}function La(){throw new is("only slices with step >= 1 are supported")}function va(n,t){n.length>t.length&&Ra(n,t)}function Pa(n,t){return n=Math.trunc(n),n<0&&(n=t+n),(n>=t||n<0)&&Oa(t),n}class Na{constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){T(this,"dim_sel");T(this,"dim_len");T(this,"dim_chunk_len");T(this,"nitems");t=Pa(t,e),this.dim_sel=t,this.dim_len=e,this.dim_chunk_len=s,this.nitems=1}*[Symbol.iterator](){const t=Math.floor(this.dim_sel/this.dim_chunk_len),e=t*this.dim_chunk_len,s=this.dim_sel-e;yield{dim_chunk_ix:t,dim_chunk_sel:s}}}class Gi{constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){T(this,"start");T(this,"stop");T(this,"step");T(this,"dim_len");T(this,"dim_chunk_len");T(this,"nitems");T(this,"nchunks");const[i,r,a]=vn(t,e);this.start=i,this.stop=r,this.step=a,this.step<1&&La(),this.dim_len=e,this.dim_chunk_len=s,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const t=Math.floor(this.start/this.dim_chunk_len),e=Math.ceil(this.stop/this.dim_chunk_len);for(const s of Da(t,e)){const i=s*this.dim_chunk_len,r=Math.min(this.dim_len,(s+1)*this.dim_chunk_len),a=r-i;let o=0,h=0;if(this.start<i){const f=(i-this.start)%this.step;f&&(h+=this.step-f),o=Math.ceil((i-this.start)/this.step)}else h=this.start-i;const l=this.stop>r?a:this.stop-i,c=[h,l,this.step],u=Math.ceil((l-h)/this.step),d=[o,o+u,1];yield{dim_chunk_ix:s,dim_chunk_sel:c,dim_out_sel:d}}}}function Ua(n,t){let e=[];return n===null?e=t.map(s=>Rs(null)):Array.isArray(n)&&(e=n.map(s=>s??Rs(null))),va(e,t),e}class Nn{constructor({selection:t,shape:e,chunk_shape:s}){T(this,"dim_indexers");T(this,"shape");this.dim_indexers=Ua(t,e).map((i,r)=>new(typeof i=="number"?Na:Gi)({dim_sel:i,dim_len:e[r],dim_chunk_len:s[r]})),this.shape=this.dim_indexers.filter(i=>i instanceof Gi).map(i=>i.nitems)}*[Symbol.iterator](){for(const t of ka(...this.dim_indexers)){const e=t.map(i=>i.dim_chunk_ix),s=t.map(i=>"dim_out_sel"in i?{from:i.dim_chunk_sel,to:i.dim_out_sel}:{from:i.dim_chunk_sel,to:null});yield{chunk_coords:e,mapping:s}}}}function Fa(n,t){return"get"in n?n.get(t):n[t]}async function Un(n,t,e,s){var h;let i=Ln(n),r=new Nn({selection:t,shape:n.shape,chunk_shape:n.chunks}),a=s.prepare(new i.TypedArray(r.shape.reduce((l,c)=>l*c,1)),r.shape,i.get_strides(r.shape)),o=((h=e.create_queue)==null?void 0:h.call(e))??Pn();for(const{chunk_coords:l,mapping:c}of r)o.add(async()=>{let{data:u,shape:d,stride:f}=await n.getChunk(l,e.opts),m=s.prepare(u,d,f);s.set_from_chunk(a,m,c)});return await o.onIdle(),r.shape.length===0?Fa(a.data,0):a}function Ba(n){return n.to==null?{from:n.to,to:n.from}:{from:n.to,to:n.from}}async function Fn(n,t,e,s,i){const r=Ln(n);if(r.kind==="sharded")throw new Error("Set not supported for sharded arrays.");const a=new Nn({selection:t,shape:n.shape,chunk_shape:n.chunks}),o=n.chunks.reduce((l,c)=>l*c,1),h=s.create_queue?s.create_queue():Pn();for(const{chunk_coords:l,mapping:c}of a){const u=c.map(f=>f.from),d=c.map(Ba);h.add(async()=>{const f=n.resolve(r.encode_chunk_key(l)).path;let m;const y=n.chunks.slice(),p=r.get_strides(y);if(qa(u,y))if(m=new r.TypedArray(o),typeof e=="object"){const g=i.prepare(m,y.slice(),p.slice());i.set_from_chunk(g,e,d)}else m.fill(e);else{m=await n.getChunk(l).then(({data:x})=>x);const g=i.prepare(m,y.slice(),p.slice());typeof e=="object"?i.set_from_chunk(g,e,d):i.set_scalar(g,u,e)}await n.store.set(f,await r.codec.encode({data:m,shape:y,stride:p}))})}await h.onIdle()}function qa(n,t){return n.every((e,s)=>{if(typeof e=="number")return!1;const[i,r,a]=e;return r-i===t[s]&&a===1})}function ti(n,t=0,e){let s=e??n.length-t;return{length:s,subarray(i,r=s){return ti(n,t+i,r-i)},set(i,r=0){for(let a=0;a<i.length;a++)n[t+r+a]=i.get(a)},get(i){return n[t+i]}}}function ps(n){return globalThis.Array.isArray(n.data)?{data:ti(n.data),stride:n.stride,bytes_per_element:1}:{data:new Uint8Array(n.data.buffer,n.data.byteOffset,n.data.byteLength),stride:n.stride,bytes_per_element:n.data.BYTES_PER_ELEMENT}}function Va(n){return"chars"in n?n.constructor.bind(null,n.chars):n.constructor}function Ga(n,t){if(globalThis.Array.isArray(n.data))return ti([t]);let e=Va(n.data),s=new e([t]);return new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}const Bn={prepare(n,t,e){return{data:n,shape:t,stride:e}},set_scalar(n,t,e){let s=ps(n);Os(s,t,Ga(n,e),s.bytes_per_element)},set_from_chunk(n,t,e){let s=ps(n);He(s,ps(t),s.bytes_per_element,e)}};async function qn(n,t=null,e={}){return Un(n,t,e,Bn)}async function Ya(n,t,e,s={}){return Fn(n,t,e,s,Bn)}function Vn(n,t,e){return e<0&&t<n?Math.floor((n-t-1)/-e)+1:n<t?Math.floor((t-n-1)/e)+1:0}function Os(n,t,e,s){if(t.length===0){n.data.set(e,0);return}const[i,...r]=t,[a,...o]=n.stride;if(typeof i=="number"){const d=n.data.subarray(a*i*s);Os({data:d,stride:o},r,e,s);return}const[h,l,c]=i,u=Vn(h,l,c);if(r.length===0){for(let d=0;d<u;d++)n.data.set(e,a*(h+c*d)*s);return}for(let d=0;d<u;d++){const f=n.data.subarray(a*(h+c*d)*s);Os({data:f,stride:o},r,e,s)}}function He(n,t,e,s){const[i,...r]=s,[a,...o]=n.stride,[h,...l]=t.stride;if(i.from===null){if(r.length===0){n.data.set(t.data.subarray(0,e),i.to*e);return}He({data:n.data.subarray(a*i.to*e),stride:o},t,e,r);return}if(i.to===null){if(r.length===0){let g=i.from*e;n.data.set(t.data.subarray(g,g+e),0);return}He(n,{data:t.data.subarray(h*i.from*e),stride:l},e,r);return}const[c,u,d]=i.to,[f,m,y]=i.from,p=Vn(c,u,d);if(r.length===0){if(d===1&&y===1&&a===1&&h===1){let g=f*e,x=p*e;n.data.set(t.data.subarray(g,g+x),c*e);return}for(let g=0;g<p;g++){let x=h*(f+y*g)*e;n.data.set(t.data.subarray(x,x+e),a*(c+d*g)*e)}return}for(let g=0;g<p;g++)He({data:n.data.subarray(a*(c+g*d)*e),stride:o},{data:t.data.subarray(h*(f+g*y)*e),stride:l},e,r)}async function $a(n){let t=await n.get("/.zmetadata");if(!t)throw new lt("v2 consolidated metadata",{cause:new Jt("/.zmetadata")});let e=It(t);return v(e.zarr_consolidated_format===1,"Unsupported consolidated format."),e}function Xa(n){return n.endsWith(".zarray")||n.endsWith(".zgroup")||n.endsWith(".zattrs")||n.endsWith("zarr.json")}function ja(n){return"zarr_format"in n&&n.zarr_format===3}async function Gn(n){var s;let t=await $a(n),e={};for(let[i,r]of Object.entries(t.metadata))e[`/${i}`]=r;return{async get(...i){let[r,a]=i;if(e[r])return Hs(e[r]);let o=await n.get(r,a);if(Xa(r)&&o){let h=It(o);e[r]=h}return o},getRange:(s=n.getRange)==null?void 0:s.bind(n),contents(){let i=[];for(let[r,a]of Object.entries(e)){let o=r.split("/"),h=o.pop(),l=o.join("/")||"/";h===".zarray"&&i.push({path:l,kind:"array"}),h===".zgroup"&&i.push({path:l,kind:"group"}),ja(a)&&i.push({path:l,kind:a.node_type})}return i}}}async function Ha(n){return Gn(n).catch(t=>(Zs(t,lt),n))}function Yn(n,t,e,s={}){return t!==void 0&&e!==void 0&&(s={...s,headers:{...s.headers,Range:`bytes=${t}-${t+e-1}`}}),fetch(n,s)}function Za(n,t){return{...n,...t,headers:{...n.headers,...t.headers}}}function Yi(n,t){const e=typeof n=="string"?new URL(n):n;e.pathname.endsWith("/")||(e.pathname+="/");const s=new URL(t.slice(1),e);return s.search=e.search,s}async function $i(n){if(n.status!==404){if(n.status===200||n.status===206)return new Uint8Array(await n.arrayBuffer());throw new Error(`Unexpected response status ${n.status} ${n.statusText}`)}}async function Ka(n,t,e,s){if(s)return fetch(n,{...e,headers:{...e.headers,Range:`bytes=-${t}`}});let i=await fetch(n,{...e,method:"HEAD"});if(!i.ok)return i;let r=i.headers.get("Content-Length"),a=Number(r);return Yn(n,a-t,a,e)}var Se,Ae,Me,Ls;class $n{constructor(t,e={}){L(this,Me);T(this,"url");L(this,Se);L(this,Ae);this.url=t,k(this,Se,e.overrides??{}),k(this,Ae,e.useSuffixRequest??!1)}async get(t,e={}){let s=Yi(this.url,t).href,i=await fetch(s,hs(this,Me,Ls).call(this,e));return $i(i)}async getRange(t,e,s={}){let i=Yi(this.url,t),r=hs(this,Me,Ls).call(this,s),a;return"suffixLength"in e?a=await Ka(i,e.suffixLength,r,z(this,Ae)):a=await Yn(i,e.offset,e.length,r),$i(a)}}Se=new WeakMap,Ae=new WeakMap,Me=new WeakSet,Ls=function(t){return Za(z(this,Se),t)};var Wa=Object.freeze({__proto__:null,Array:Kt,BoolArray:js,ByteStringArray:es,FetchStore:$n,Group:Ie,IndexError:is,KeyError:Jt,Location:ct,NodeNotFoundError:lt,UnicodeStringArray:Zt,_zarrita_internal_get:Un,_zarrita_internal_get_strides:_t,_zarrita_internal_set:Fn,_zarrita_internal_slice_indices:vn,create:Ia,get:qn,open:ot,registry:Rn,root:On,set:Ya,slice:Rs,tryWithConsolidated:Ha,withConsolidated:Gn});const Xi="request cancelled";class Xn{constructor(t=10,e=5){this.allRequests=new Map,this.activeRequests=new Set,this.queue=[],this.queueLowPriority=[],this.maxActiveRequests=t,this.maxLowPriorityRequests=Math.min(t,e)}registerRequest(t,e){let s,i;const r=new Promise((o,h)=>{s=o,i=h}),a={key:t,action:e,resolve:s,reject:i,promise:r};return this.allRequests.set(t,a),a}addRequestToQueue(t,e){if(this.allRequests.has(t)){const s=this.allRequests.get(t);s&&s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=void 0),!this.queue.includes(t)&&!this.queueLowPriority.includes(t)&&(e?this.queueLowPriority.push(t):this.queue.push(t),this.dequeue())}}addRequest(t,e,s=!1,i=0){var a;if(this.allRequests.has(t)){const o=this.queueLowPriority.indexOf(t);o>-1&&!s?(this.queueLowPriority.splice(o,1),this.addRequestToQueue(t)):i<=0&&this.addRequestToQueue(t,s)}else{const o=this.registerRequest(t,e);if(i>0){const h=setTimeout(()=>this.addRequestToQueue(t,s),i);o.timeoutId=h}else this.addRequestToQueue(t,s)}const r=(a=this.allRequests.get(t))==null?void 0:a.promise;if(!r)throw new Error("Found no promise to return when getting stored request data.");return r}addRequests(t,e=!1,s=10){const i=[];for(let r=0;r<t.length;r++){const a=t[r],o=this.addRequest(a.key,a.requestAction,e,s*r);i.push(o)}return i}async dequeue(){const t=this.activeRequests.size;if(t>=this.maxActiveRequests||this.queue.length===0&&(t>=this.maxLowPriorityRequests||this.queueLowPriority.length===0))return;const e=this.queue.shift()??this.queueLowPriority.shift();if(!e)return;if(this.activeRequests.has(e)){this.dequeue();return}const s=this.allRequests.get(e);if(!s)return;const i=s.key;this.activeRequests.add(i),await s.action().then(s.resolve,s.reject),this.activeRequests.delete(i),this.allRequests.delete(i),this.dequeue()}cancelRequest(t,e=Xi){if(!this.allRequests.has(t))return;const s=this.allRequests.get(t);s&&(s.timeoutId&&clearTimeout(s.timeoutId),s.reject(e));const i=this.queue.indexOf(t);if(i>-1)this.queue.splice(i,1);else{const r=this.queueLowPriority.indexOf(t);r>-1&&this.queueLowPriority.splice(r,1)}this.allRequests.delete(t),this.activeRequests.delete(t)}cancelAllRequests(t=Xi){this.queue=[],this.queueLowPriority=[];for(const e of this.allRequests.keys())this.cancelRequest(e,t)}hasRequest(t){return this.allRequests.has(t)}requestRunning(t){return this.activeRequests.has(t)}}class jn{constructor(t,e){typeof t=="number"||t===void 0?this.queue=new Xn(t,e):this.queue=t,this.nextSubscriberId=0,this.subscribers=new Map,this.requests=new Map}resolveAll(t,e){var i;const s=this.requests.get(t);if(s){for(const{resolve:r,subscriberId:a}of s)r(e),(i=this.subscribers.get(a))==null||i.delete(t);this.requests.delete(t)}}rejectAll(t,e){var i;const s=this.requests.get(t);if(s){for(const{reject:r,subscriberId:a}of s)r(e),(i=this.subscribers.get(a))==null||i.delete(t);this.requests.delete(t)}}addSubscriber(){const t=this.nextSubscriberId;return this.nextSubscriberId++,this.subscribers.set(t,new Map),t}addRequest(t,e,s,i,r){if(this.queue.addRequest(t,s,i,r).then(o=>this.resolveAll(t,o)).catch(o=>this.rejectAll(t,o)),this.requests.has(t)||this.requests.set(t,[]),e>=this.nextSubscriberId||e<0)throw new Error(`SubscribableRequestQueue: subscriber id ${e} has not been registered`);if(!this.subscribers.get(e))throw new Error(`SubscribableRequestQueue: subscriber id ${e} has been removed`);return new Promise((o,h)=>{var u;(u=this.requests.get(t))==null||u.push({resolve:o,reject:h,subscriberId:e});const l=this.subscribers.get(e),c=l==null?void 0:l.get(t);c?c.push(h):l==null||l.set(t,[h])})}rejectSubscription(t,e,s){e(s);const i=this.requests.get(t);if(!i)return;const r=i.findIndex(a=>a.reject===e);r>=0&&i.splice(r,1),i.length<1&&!this.queue.requestRunning(t)&&(this.queue.cancelRequest(t,s),this.requests.delete(t))}cancelRequest(t,e,s){const i=this.subscribers.get(e);if(!i)return!1;const r=i.get(t);if(!r||!r.length)return!1;for(const a of r)this.rejectSubscription(t,a,s);return i.delete(t),!0}removeSubscriber(t,e){const s=this.subscribers.get(t);if(s){for(const[i,r]of s.entries())for(const a of r)this.rejectSubscription(i,a,e);this.subscribers.delete(t)}}hasRequest(t){return this.queue.hasRequest(t)}requestRunning(t){return this.queue.requestRunning(t)}hasSubscriber(t){return this.subscribers.has(t)}isSubscribed(t,e){var s;return((s=this.subscribers.get(t))==null?void 0:s.has(e))??!1}}const ji=256;class Et{constructor(t){this.dataMinBin=0,this.dataMaxBin=0,this.maxBin=0,this.bins=new Uint32Array,this.min=0,this.max=0,this.binSize=0;const e=Et.calculateHistogram(t,ji);this.bins=e.bins,this.min=e.min,this.max=e.max,this.binSize=e.binSize;for(let i=0;i<this.bins.length;i++)if(this.bins[i]>0){this.dataMinBin=i;break}for(let i=this.bins.length-1;i>=0;i--)if(this.bins[i]>0){this.dataMaxBin=i;break}this.pixelCount=t.length,this.maxBin=1;let s=this.bins[1];for(let i=1;i<this.bins.length;i++)this.bins[i]>s&&(this.maxBin=i,s=this.bins[i])}static findBin(t,e,s,i){let r=Math.floor((t-e)/s);return r===i&&r--,r}findBinOfValue(t){return Et.findBin(t,this.min,this.binSize,ji)}getDataMin(){return this.min}getDataMax(){return this.max}getMin(){return this.dataMinBin}getMax(){return this.dataMaxBin}getNumBins(){return this.bins.length}getBin(t){return this.bins[t]}getBinRange(t){return[this.min+t*this.binSize,this.min+(t+1)*this.binSize]}findBinOfPercentile(t){const e=this.pixelCount*t;let s=0,i=0;for(s=0;s<this.bins.length&&(i+=this.bins[s],!(i>e));++s);return s}findBestFitBins(){const e=this.pixelCount/10;let s=0,i=0;for(s=1;s<this.bins.length&&(i+=this.bins[s],!(i>e));++s);const r=s;for(i=0,s=this.bins.length-1;s>=1&&(i+=this.bins[s],!(i>e));--s);return[r,s]}findAutoIJBins(){const e=this.pixelCount,s=e/10,i=e/5e3;let r=this.bins.length-1,a=1;for(let o=1;o<this.bins.length;++o)if(this.bins[o]>i&&this.bins[o]<=s){r=o;break}for(let o=this.bins.length-1;o>=1;--o)if(this.bins[o]>i&&this.bins[o]<=s){a=o;break}return a<r&&(r=0,a=255),[r,a]}findAutoMinMax(){const e=Math.floor(this.bins[this.maxBin]*.1);let s=0,i=this.bins.length-1;for(let r=1;r<this.bins.length;++r)if(this.bins[r]>e){s=r;break}for(let r=this.bins.length-1;r>=1;--r)if(this.bins[r]>e){i=r;break}return[s,i]}static calculateHistogram(t,e=1){e<1&&(e=1);let s=t[0],i=t[0];for(let o=1;o<t.length;o++)t[o]<s?s=t[o]:t[o]>i&&(i=t[o]);const r=new Uint32Array(e).fill(0),a=(i-s)/e===0?1:(i-s)/e;for(let o=0;o<t.length;o++){const h=t[o],l=Et.findBin(h,s,a,e);r[l]++}return{bins:r,min:s,max:i,binSize:a}}}const gs=[[255,0,255],[255,255,255],[0,255,255]];function Ja(n,t,e){let s,i,r,a=0;if(arguments.length===1){const d=n;t=d.s,e=d.v,a=d.h}else a=n;const o=Math.floor(a*6),h=a*6-o,l=e*(1-t),c=e*(1-h*t),u=e*(1-(1-h)*t);switch(o%6){case 0:s=e,i=u,r=l;break;case 1:s=c,i=e,r=l;break;case 2:s=l,i=e,r=u;break;case 3:s=l,i=c,r=e;break;case 4:s=u,i=l,r=e;break;case 5:s=e,i=l,r=c;break}return[Math.round(s*255),Math.round(i*255),Math.round(r*255)]}function Qa(n){return function(){return n=Math.imul(48271,n)|0%2147483647,(n&2147483647)/2147483648}}const xs=Qa(123),Ze=n=>(gs[n]||(gs[n]=Ja(xs(),xs()*.5+.5,xs()*.5+.5)),gs[n]);function qt(n,t,e){return Math.min(Math.max(t,n),e)}function gt(n,t,e){return e*(t-n)+n}function to(n,t,e,s,i,r,a){const o=(n-t)/(e-t),l=((a-r)*o+r-s)/(i-s);return t+l*(e-t)}function eo(n,t,e,s,i,r,a){const o=(n-t)/(e-t),l=((i-s)*o+s-r)/(a-r);return t+l*(e-t)}const st=256,yt=st*4;function so(n){const t=st,e=new Uint8Array(t*4).fill(0);if(n.length===0)return e;if(n.sort((l,c)=>l.x-c.x),n.length===1){const l=Pe(n[0]),c=qt(n[0].x,0,255);for(let u=c;u<t;++u)e[u*4+0]=l[0],e[u*4+1]=l[1],e[u*4+2]=l[2],e[u*4+3]=l[3];return e}let s=n[0],i=n[1],r=Pe(s),a=Pe(i),o=1,h=0;for(let l=0;l<t;++l){for(;l>i.x;)s=i,r=a,o++,o>=n.length?i={x:255,color:i.color,opacity:i.opacity}:i=n[o],a=Pe(i);i.x===s.x?h=1:h=(l-s.x)/(i.x-s.x),e[l*4+0]=qt(gt(r[0],a[0],h),0,255),e[l*4+1]=qt(gt(r[1],a[1],h),0,255),e[l*4+2]=qt(gt(r[2],a[2],h),0,255),e[l*4+3]=qt(gt(r[3],a[3],h),0,255)}return e}function Pe(n){return[n.color[0],n.color[1],n.color[2],Math.floor(n.opacity*255)]}const _s=(n=0,t=1)=>[{x:0,opacity:n,color:[255,255,255]},{x:255,opacity:t,color:[255,255,255]}];class io{constructor(){this.lut=new Uint8Array(yt),this.controlPoints=[],this.createFullRange()}createFromMinMax(t,e){if(e<t){const a=e;e=t,t=a}if(t<0&&e<0)return this.controlPoints=_s(1,1),this.createFromControlPoints(this.controlPoints);if(t>=255&&e>=255)return this.controlPoints=_s(0,0),this.createFromControlPoints(this.controlPoints);const s=[];let i=0;t<0&&(i=-t/(e-t)),s.push({x:0,opacity:i,color:[255,255,255]}),t>0&&s.push({x:t,opacity:0,color:[255,255,255]}),e<255&&(e===t?s.push({x:t+.5,opacity:1,color:[255,255,255]}):s.push({x:e,opacity:1,color:[255,255,255]}));let r=1;return e>255&&(r=(255-t)/(e-t)),s.push({x:255,opacity:r,color:[255,255,255]}),this.createFromControlPoints(s)}createFullRange(){return this.controlPoints=_s(),this.createFromControlPoints(this.controlPoints)}createFromWindowLevel(t,e){const s=e-t*.5,i=e+t*.5;return this.createFromMinMax(s*255,i*255)}createFromControlPoints(t){return this.lut=so(t),this.controlPoints=t,this}createFromEqHistogram(t){const e=[];for(let i=0;i<t.getNumBins();++i)e[i]=0;e[0]=t.getBin(0);for(let i=1;i<t.getNumBins();++i)e[i]=e[i-1]+t.getBin(i);if(e[e.length-1]-e[0]>0){const i=[{x:0,opacity:0,color:[255,255,255]}];let r=0,a=0,o=0,h=0;for(let l=1;l<st;++l)h=o,o=qt(Math.round(255*(e[l]-e[0])),0,255),r=o-h,r!=a&&(i.push({x:l-1,opacity:h/255,color:[255,255,255]}),a=r);return i.push({x:255,opacity:1,color:[255,255,255]}),this.createFromControlPoints(i)}else return this.createFullRange()}createLabelColors(t){const e=new Uint8Array(yt).fill(0),s=[];s.push({x:0,opacity:0,color:[0,0,0]});let i=0,r=0,a=0,o=0,h=0,l=0,c=0,u=0;for(let d=1;d<st;++d){const f=Math.floor(d/(st-1)*(t.getNumBins()-1));if(t.getBin(f)>0){const m=Ze(f);e[d*4+0]=m[0],e[d*4+1]=m[1],e[d*4+2]=m[2],e[d*4+3]=255,h=m[0],l=m[1],c=m[2],u=1}else h=0,l=0,c=0,u=0;(h!==i||l!==r||c!==a||u!==o)&&(o===0&&s.push({x:d-.5,opacity:o,color:[i,r,a]}),s.push({x:d,opacity:u,color:[h,l,c]}),i=h,r=l,a=c,o=u)}return this.lut=e,this.controlPoints=s,this}remapDomains(t,e,s,i){this.lut=no(this.lut,t,e,s,i),this.controlPoints=ro(this.controlPoints,t,e,s,i)}}function no(n,t,e,s,i){const r=new Uint8Array(yt);for(let a=0;a<st;++a){let o=to(a,0,st-1,t,e,s,i);o<0&&(o=0),o>st-1&&(o=st-1);const h=Math.floor(o),l=Math.ceil(o),c=o-h;r[a*4+0]=Math.round(gt(n[h*4+0],n[l*4+0],c)),r[a*4+1]=Math.round(gt(n[h*4+1],n[l*4+1],c)),r[a*4+2]=Math.round(gt(n[h*4+2],n[l*4+2],c)),r[a*4+3]=Math.round(gt(n[h*4+3],n[l*4+3],c))}return r}function ro(n,t,e,s,i,r=!0){if(n.length===0)return n;const a=[],o=n[0].x,h=n[n.length-1].x;for(let l=0;l<n.length;++l){const c=n[l],d={x:eo(c.x,0,st-1,t,e,s,i),opacity:c.opacity,color:[c.color[0],c.color[1],c.color[2]]};a.push(d)}return r?ao(a,o,h):a}function ao(n,t,e){const i=n[0],r=n[1],a=n[n.length-2],o=n[n.length-1];return Math.abs(i.opacity-((r==null?void 0:r.opacity)??1/0))<1e-4&&(i.x<0?i.x=Math.min(0,r.x-1):t<1e-4&&(i.x=0)),Math.abs(o.opacity-((a==null?void 0:a.opacity)??1/0))<1e-4&&(o.x>255?o.x=Math.max(255,a.x+1):e>255-1e-4&&(o.x=255)),n}const Hi={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float32:Float32Array,float64:Float64Array};class Zi{constructor(t){this.loaded=!1,this.dtype="uint8",this.imgData={data:new Uint8Array,width:0,height:0},this.rawMin=0,this.rawMax=255,this.frame=0,this.dataTexture=new ys(new Uint8Array,0,0),this.lutTexture=new ys(new Uint8Array(yt),256,1,In,je),this.lutTexture.minFilter=this.lutTexture.magFilter=En,this.lutTexture.generateMipmaps=!1,this.volumeData=new Uint8Array,this.name=t,this.histogram=new Et(new Uint8Array),this.dims=[0,0,0],this.lut=new io().createFromMinMax(0,255),this.colorPalette=new Uint8Array(yt).fill(0),this.colorPaletteAlpha=0}combineLuts(t,e){const s=e||new Uint8Array(yt);if(!t)return s;const i=[t[0]/255,t[1]/255,t[2]/255];if(this.colorPaletteAlpha===1)s.set(this.colorPalette);else if(this.colorPaletteAlpha===0){s.set(this.lut.lut);for(let r=0;r<yt/4;++r)s[r*4+0]*=i[0],s[r*4+1]*=i[1],s[r*4+2]*=i[2]}else for(let r=0;r<yt/4;++r)s[r*4+0]=this.colorPalette[r*4+0]*this.colorPaletteAlpha+this.lut.lut[r*4+0]*(1-this.colorPaletteAlpha)*i[0],s[r*4+1]=this.colorPalette[r*4+1]*this.colorPaletteAlpha+this.lut.lut[r*4+1]*(1-this.colorPaletteAlpha)*i[1],s[r*4+2]=this.colorPalette[r*4+2]*this.colorPaletteAlpha+this.lut.lut[r*4+2]*(1-this.colorPaletteAlpha)*i[2],s[r*4+3]=this.colorPalette[r*4+3]*this.colorPaletteAlpha+this.lut.lut[r*4+3]*(1-this.colorPaletteAlpha);return this.lutTexture.image.data.set(s),this.lutTexture.needsUpdate=!0,s}setRawDataRange(t,e){!(this.rawMin===0&&this.rawMax===0)&&!(t===0&&e===0)&&(this.lut.remapDomains(this.rawMin,this.rawMax,t,e),this.rawMin=t,this.rawMax=e)}getHistogram(){return this.histogram}getIntensity(t,e,s){return this.volumeData[t+e*this.dims[0]+s*(this.dims[0]*this.dims[1])]}normalizeRaw(t){return(t-this.rawMin)/(this.rawMax-this.rawMin)}getIntensityFromAtlas(t,e,s){const i=this.imgData.width/this.dims[0],r=s%i,a=Math.floor(s/i),o=r*this.dims[0]+t+(a*this.dims[1]+e)*this.imgData.width;return this.imgData.data[o]}rebuildDataTexture(t,e,s){this.dataTexture&&this.dataTexture.dispose();let i=$r,r=je,a="LUMINANCE";switch(this.dtype){case"uint8":r=je,i=kt,a="R8UI";break;case"int8":r=Fr,i=kt,a="R8I";break;case"uint16":r=qr,i=kt,a="R16UI";break;case"int16":r=Br,i=kt,a="R16I";break;case"uint32":r=Gr,i=kt,a="R32UI";break;case"int32":r=Vr,i=kt,a="R32I";break;case"float32":r=Yr,i=Xr,a="R32F";break;default:console.warn("unsupported dtype for channel data",this.dtype);break}this.dataTexture=new ys(t,e,s,i,r,$s,Gt,Gt,Ke,Ke),this.dataTexture.internalFormat=a,this.dataTexture.needsUpdate=!0}setFromAtlas(t,e,s,i,r,a,o,h=0){this.dtype=i,this.imgData={data:t,width:e,height:s},this.rebuildDataTexture(this.imgData.data,e,s),this.loaded=!0,this.histogram=new Et(t),this.frame=h,this.setRawDataRange(r,a),this.unpackFromAtlas(o.x,o.y,o.z)}unpackFromAtlas(t,e,s){const i=this.imgData.data;this.dims=[t,e,s];const r=Hi[this.dtype];this.volumeData=new r(t*e*s);const a=this.imgData.width/t,o=this.imgData.width;let h=0,l=0,c=0,u=0,d=0;for(let f=0;f<s;++f){h=f%a,l=Math.floor(f/a),c=h*t+l*e*o;for(let m=0;m<e;++m)u=m*o,d=f*(t*e)+m*t,this.volumeData.set(i.subarray(c+u,c+u+t),d)}}setFromVolumeData(t,e,s,i,r,a,o,h,l,c=0){this.dims=[e,s,i],this.volumeData=t,this.dtype=l,this.frame=c,this.packToAtlas(e,s,i,r,a),this.loaded=!0,this.setRawDataRange(o,h),this.histogram=new Et(this.volumeData)}packToAtlas(t,e,s,i,r){(i%t!==0||r%e!==0||i/t*(r/e)<s)&&(console.log("ERROR - atlas and volume dims are inconsistent"),console.log(i,r,t,e,s));const a=Hi[this.dtype];this.imgData={width:i,height:r,data:new a(i*r)},this.imgData.data.fill(0);const o=this.imgData.data,h=t,l=e,c=s,u=this.imgData.width/h,d=this.imgData.width;let f=0,m=0,y=0,p=0,g=0;for(let x=0;x<c;++x){f=x%u,m=Math.floor(x/u),y=f*h+m*l*d;for(let _=0;_<l;++_)p=_*d,g=x*(h*l)+_*h,o.set(this.volumeData.subarray(g,g+h),y+p)}this.rebuildDataTexture(this.imgData.data,i,r)}setLut(t){this.lut=t}setColorPalette(t){this.colorPalette=t}setColorPaletteAlpha(t){this.colorPaletteAlpha=t}}function Ki(n){return new b(n.shape[4],n.shape[3],n.shape[2])}function oo(n){return new b(n.spacing[4],n.spacing[3],n.spacing[2])}function Hn(){return{name:"",atlasTileDims:[1,1],subregionSize:[1,1,1],subregionOffset:[0,0,0],combinedNumChannels:1,channelNames:["0"],channelColors:[[255,255,255]],multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,1,1,1,1],spacing:[1,1,1,1,1],spaceUnit:"",timeUnit:"",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}}}class ns{constructor(t){this.imageInfo=t||Hn()}get currentLevelDims(){return this.imageInfo.multiscaleLevelDims[this.imageInfo.multiscaleLevel]}get numChannels(){return this.imageInfo.combinedNumChannels}get originalSize(){return Ki(this.imageInfo.multiscaleLevelDims[0])}get volumeSize(){return Ki(this.currentLevelDims)}get physicalPixelSize(){return oo(this.imageInfo.multiscaleLevelDims[0])}get spatialUnit(){return this.imageInfo.multiscaleLevelDims[0].spaceUnit}get times(){return this.currentLevelDims.shape[0]}get timeScale(){return this.currentLevelDims.spacing[0]}get timeUnit(){return this.currentLevelDims.timeUnit}get numMultiscaleLevels(){return this.imageInfo.multiscaleLevelDims.length}get channelNames(){return this.imageInfo.channelNames}get channelColors(){return this.imageInfo.channelColors}get subregionSize(){return new b(...this.imageInfo.subregionSize)}get subregionOffset(){return new b(...this.imageInfo.subregionOffset)}get multiscaleLevel(){return this.imageInfo.multiscaleLevel}get atlasTileDims(){return new Mt(...this.imageInfo.atlasTileDims)}get transform(){return{translation:new b(...this.imageInfo.transform.translation),rotation:new b(...this.imageInfo.transform.rotation),scale:new b(...this.imageInfo.transform.scale)}}}function ho(n){const{atlasTileDims:t}=n,e=n.multiscaleLevelDims[n.multiscaleLevel];return[t[0]*e.shape[4],t[1]*e.shape[3]]}const le=4096,Ne={angstrom:"",day:"d",foot:"ft",hour:"h",inch:"in",meter:"m",micron:"m",mile:"mi",minute:"min",parsec:"pc",second:"s",yard:"yd"},lo=["meter","second"],Wi={micro:"",deca:"da"};function Ji(n){if(n===void 0)return null;if(Ne[n])return Ne[n];const t=lo.find(e=>n.endsWith(e));if(t){const e=n.substring(0,n.length-t.length);return Wi[e]?Wi[e]+Ne[t]:(e.endsWith("a")?e[0].toUpperCase():e[0])+Ne[t]}return null}function ce(n,t,e){let s=1,i=n,r=i*t/(s*e),a=s,o=i;for(;r>1;)a=s,o=i,i-=1,s=Math.ceil(n/i),r=i*t/(s*e);return new Mt(a,o)}function Zn(n,t=le){const e=n[2],s=n[1],i=n[0],r=Math.floor(t/e),a=Math.floor(t/s);return r*a>=i}function co(n,t=le){if(n.length<=1)return 0;for(let e=0;e<n.length;++e)if(Zn(n[e],t))return e}const ws=n=>Math.max(Math.ceil(n),1),uo=(n,[t,e,s])=>[ws(t*n.z),ws(e*n.y),ws(s*n.x)];function fo(n,t){const e=n.getSize(new b);return t.map(s=>uo(e,s))}function Kn(n,t){if(n.useExplicitLevel&&n.multiscaleLevel!==void 0)return Math.max(0,Math.min(t.length-1,n.multiscaleLevel));let e=co(t,n.maxAtlasEdge);if(e!==void 0&&(e=Math.max(e+(n.scaleLevelBias??0),n.multiscaleLevel??0),e=Math.max(0,Math.min(t.length-1,e)),Zn(t[e],n.maxAtlasEdge)))return e;e===void 0&&(e=t.length-1);const s=t[e];return console.error(`Volume is too large; no multiscale level found that fits in preferred memory footprint. Selected level ${e}  has dimensions `,s,`. Max atlas edge allowed is ${n.maxAtlasEdge}.`),console.log("All available levels: ",t),e}function Qi(n,t){const e=fo(n.subregion,t);return Kn(n,e)}function tn(n,t){const e=n.min.clone().multiply(t).floor(),s=n.max.clone().multiply(t).ceil();return e.x===s.x&&e.x<t.x&&(s.x+=1),e.y===s.y&&e.y<t.y&&(s.y+=1),e.z===s.z&&e.z<t.z&&(s.z+=1),new it(e,s)}function en(n,t){const e=t.getSize(new b),s=n.min.clone().multiply(e).add(t.min),i=n.max.clone().multiply(e).add(t.min);return new it(s,i)}function mo(n){for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t))return!1;return!0}function yo(n){const t=new ns(n),e=t.volumeSize.clone().multiply(t.physicalPixelSize),s={};return s.Dimensions={...t.subregionSize},s["Original dimensions"]={...t.originalSize},s["Physical size"]={x:e.x+t.spatialUnit,y:e.y+t.spatialUnit,z:e.z+t.spatialUnit},s["Physical size per pixel"]={x:t.physicalPixelSize.x+t.spatialUnit,y:t.physicalPixelSize.y+t.spatialUnit,z:t.physicalPixelSize.z+t.spatialUnit},s["Multiresolution levels"]=n.multiscaleLevelDims,s.Channels=n.combinedNumChannels,s["Time series frames"]=t.times||1,n.userData&&!mo(n.userData)&&(s["User data"]=n.userData),s}class po{constructor(t=Hn(),e=new Wn,s){if(this.loaded=!1,this.imageInfo=new ns(t),this.name=t.name,this.loadSpec={multiscaleLevel:0,scaleLevelBias:0,maxAtlasEdge:le,channels:Array.from({length:this.imageInfo.numChannels},(i,r)=>r),...e},this.loadSpecRequired={...this.loadSpec,channels:this.loadSpec.channels.slice(),subregion:this.loadSpec.subregion.clone()},this.loader=s,this.imageMetadata={},this.normRegionSize=new b(1,1,1),this.normRegionOffset=new b(0,0,0),this.physicalSize=new b(1,1,1),this.physicalScale=1,this.normPhysicalSize=new b(1,1,1),this.physicalPixelSize=this.imageInfo.physicalPixelSize,this.tickMarkPhysicalLength=1,this.setVoxelSize(this.physicalPixelSize),this.numChannels=this.imageInfo.numChannels,this.channelNames=this.imageInfo.channelNames.slice(),this.channelColorsDefault=this.imageInfo.channelColors?this.imageInfo.channelColors.slice():this.channelNames.map((i,r)=>Ze(r)),this.channelColorsDefault.length<this.imageInfo.numChannels)for(let i=this.channelColorsDefault.length-1;i<this.imageInfo.numChannels;++i)this.channelColorsDefault[i]=Ze(i);this.channels=[];for(let i=0;i<this.imageInfo.numChannels;++i){const r=new Zi(this.channelNames[i]);this.channels.push(r),r.dims=this.imageInfo.subregionSize.toArray()}this.physicalUnitSymbol=this.imageInfo.spatialUnit,this.volumeDataObservers=[]}setUnloaded(){this.loaded=!1,this.channels.forEach(t=>{t.loaded=!1})}isLoaded(){return this.loaded}updateDimensions(){const{volumeSize:t,subregionSize:e,subregionOffset:s}=this.imageInfo;this.setVoxelSize(this.physicalPixelSize),this.normRegionSize=e.clone().divide(t),this.normRegionOffset=s.clone().divide(t)}mustLoadNewData(){return this.loadSpec.useExplicitLevel!==this.loadSpecRequired.useExplicitLevel||this.loadSpec.time!==this.loadSpecRequired.time||!this.loadSpec.subregion.containsBox(this.loadSpecRequired.subregion)||this.loadSpecRequired.channels.some(t=>!this.loadSpec.channels.includes(t))}mayLoadNewScaleLevel(){return!this.loadSpec.subregion.equals(this.loadSpecRequired.subregion)||this.loadSpecRequired.maxAtlasEdge!==this.loadSpec.maxAtlasEdge||this.loadSpecRequired.multiscaleLevel!==this.loadSpec.multiscaleLevel||this.loadSpecRequired.scaleLevelBias!==this.loadSpec.scaleLevelBias}async updateRequiredData(t,e){this.loadSpecRequired={...this.loadSpecRequired,...t};let s=this.mustLoadNewData();if(!s&&this.mayLoadNewScaleLevel()){const i=await this.loadScaleLevelDims();if(i){const r=i.map(({shape:o})=>[o[2],o[3],o[4]]),a=Kn(this.loadSpecRequired,r);s=this.imageInfo.multiscaleLevel!==a}}s&&await this.loadNewData(e)}async loadScaleLevelDims(){var t;try{return await((t=this.loader)==null?void 0:t.loadDims(this.loadSpecRequired))}catch(e){this.volumeDataObservers.forEach(s=>s.onVolumeLoadError(this,e));return}}async loadNewData(t){var e;this.setUnloaded(),this.loadSpec={...this.loadSpecRequired,subregion:this.loadSpecRequired.subregion.clone()};try{await((e=this.loader)==null?void 0:e.loadVolumeData(this,void 0,t))}catch(s){throw this.volumeDataObservers.forEach(i=>i.onVolumeLoadError(this,s)),s}}setVoxelSize(t){t.x=t.x>0?t.x:1,t.y=t.y>0?t.y:1,t.z=t.z>0?t.z:1,this.physicalPixelSize=t,this.physicalSize=this.imageInfo.originalSize.clone().multiply(this.physicalPixelSize),this.physicalScale=Math.max(this.physicalSize.x,this.physicalSize.y,this.physicalSize.z),this.normPhysicalSize=this.physicalSize.clone().divideScalar(this.physicalScale),this.tickMarkPhysicalLength=10**Math.floor(Math.log10(this.physicalScale/2))}setUnitSymbol(t){this.physicalUnitSymbol=t}getContentCenter(){return this.normRegionSize.clone().divideScalar(2).add(this.normRegionOffset).subScalar(.5).multiply(this.normPhysicalSize)}cleanup(){}getChannel(t){return this.channels[t]}onChannelLoaded(t){this.loadSpec.channels.every(e=>this.channels[e].loaded)&&(this.loaded=!0),t.forEach(e=>{var s;return(s=this.channelLoadCallback)==null?void 0:s.call(this,this,e)}),this.volumeDataObservers.forEach(e=>e.onVolumeData(this,t))}setChannelDataFromAtlas(t,e,s,i,r,a="uint8",o=0){this.channels[t].setFromAtlas(e,s,i,a,r[0],r[1],this.imageInfo.subregionSize,o),this.onChannelLoaded([t])}setChannelDataFromVolume(t,e,s,i="uint8",r=0){const{subregionSize:a,atlasTileDims:o}=this.imageInfo;this.channels[t].setFromVolumeData(e,a.x,a.y,a.z,o.x*a.x,o.y*a.y,s[0],s[1],i,r),this.onChannelLoaded([t])}appendEmptyChannel(t,e){const s=this.imageInfo.numChannels,i=t||"channel_"+s,r=e||Ze(s);this.numChannels+=1,this.channelNames.push(i),this.channelColorsDefault.push(r),this.channels.push(new Zi(i));for(let a=0;a<this.volumeDataObservers.length;++a)this.volumeDataObservers[a].onVolumeChannelAdded(this,s);return s}getIntensity(t,e,s,i){return this.channels[t].getIntensity(e,s,i)}getHistogram(t){return this.channels[t].getHistogram()}setLut(t,e){this.channels[t].setLut(e)}setColorPalette(t,e){this.channels[t].setColorPalette(e)}setColorPaletteAlpha(t,e){this.channels[t].setColorPaletteAlpha(e)}getRotation(){return this.imageInfo.transform.rotation.toArray()}getTranslation(){return this.voxelsToWorldSpace(this.imageInfo.transform.translation.toArray())}voxelsToWorldSpace(t){const e=1/Math.max(this.physicalSize.x,Math.max(this.physicalSize.y,this.physicalSize.z));return new b().fromArray(t).multiply(this.physicalPixelSize).multiplyScalar(e).toArray()}addVolumeDataObserver(t){this.volumeDataObservers.push(t)}removeVolumeDataObserver(t){if(t){const e=this.volumeDataObservers.indexOf(t);e!==-1&&this.volumeDataObservers.splice(e,1)}}removeAllVolumeDataObservers(){this.volumeDataObservers=[]}}class Wn{constructor(){this.time=0,this.subregion=new it(new b(0,0,0),new b(1,1,1)),this.useExplicitLevel=!1}}class rs{setPrefetchPriority(t){}syncMultichannelLoading(t){}updateFetchOptions(t){}async createVolume(t,e){const{imageInfo:s,loadSpec:i}=await this.createImageInfo(t),r=new po(s,i,this);return r.channelLoadCallback=e,r.imageMetadata=yo(s),r}async loadVolumeData(t,e,s){const i=(o,h)=>{o&&(t.imageInfo=new ns(o),t.updateDimensions()),t.loadSpec={...h,...a}},r=(o,h,l,c,u)=>{for(let d=0;d<o.length;d++){const f=o[d],m=h[d],y=l[d],p=c[d],g=t.loadSpec.time;u?t.setChannelDataFromAtlas(f,y,u[0],u[1],p,m,g):t.setChannelDataFromVolume(f,y,p,m,g),s==null||s(t,f)}},a={...t.loadSpec,...e};return this.loadRawChannelData(t.imageInfo.imageInfo,a,i,r)}}const go=n=>n.every(t=>t===n[0]),xo=(n,t,e)=>{for(let s=0;s<e;s++)n.push(t)},Ue=n=>{const t=n>>1;return t+ +(t!==0)};function Fe(n,t){n<t[0]&&(t[0]=n),n>t[1]&&(t[1]=n)}class Je{constructor(t,e,s,i,r=!1){const a=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]];for(const o of t)Fe(o[0],a[0]),Fe(o[2],a[1]),Fe(o[3],a[2]),Fe(o[4],a[3]);if(a.flat().some(o=>!Number.isFinite(o))){this.directionStates=[],this.priorityDirectionStates=[];return}this.directionStates=[],this.priorityDirectionStates=[];for(const[o,h]of a.flat().entries()){const l=o>>1,c=l+ +(l!==0);let u;if(o&1){const f=s.map(m=>Math.min(h+e[l],m[c]-1));if(go(f))u=f[0];else{u=[];for(const[m,y]of f.entries())xo(u,y,s[m][1])}}else u=Math.max(h-e[l],0);const d={direction:o,start:h,end:u,chunks:[]};i&&i.includes(o)?this.priorityDirectionStates.push(d):r||this.directionStates.push(d)}for(const o of t){for(const h of this.directionStates)o[Ue(h.direction)]===h.start&&h.chunks.push(o);for(const h of this.priorityDirectionStates)o[Ue(h.direction)]===h.start&&h.chunks.push(o)}}static*iterateDirections(t){let e=1;for(;t.length>0;){t=t.filter(s=>{const i=Array.isArray(s.end)?Math.max(...s.end):s.end;return s.direction&1?s.start+e<=i:s.start-e>=i});for(const s of t){const i=e*(s.direction&1?1:-1);for(const r of s.chunks){if(Array.isArray(s.end)&&r[Ue(s.direction)]+i>s.end[r[1]])continue;const a=r.slice();a[Ue(s.direction)]+=i,yield a}}e+=1}}*[Symbol.iterator](){if(this.priorityDirectionStates.length>0)for(const t of Je.iterateDirections(this.priorityDirectionStates))yield t;for(const t of Je.iterateDirections(this.directionStates))yield t}}var P=(n=>(n.UNKNOWN="unknown",n.NOT_FOUND="not_found",n.TOO_LARGE="too_large",n.LOAD_DATA_FAILED="load_data_failed",n.INVALID_METADATA="invalid_metadata",n.INVALID_MULTI_SOURCE_ZARR="invalid_multi_source_zarr",n))(P||{});class B extends Error{constructor(t,e){super(t,e),this.name="VolumeLoadError",this.type=(e==null?void 0:e.type)??"unknown"}}Qe.set("NodeNotFoundError",lt);Qe.set("KeyError",Jt);Qe.set("VolumeLoadError",B);function Yt(n="Unknown error occurred while loading volume data",t="unknown",e){return s=>{if(e!==void 0&&s===e)return s;throw s instanceof B?s:(console.log(`Error loading volume data: ${s}`),new B(n,{type:t,cause:s}))}}function _o(n){var s;if((s=n.omeroMetadata)!=null&&s.channels)return n.omeroMetadata.channels.map(({label:i},r)=>i??`Channel ${r+n.channelOffset}`);const t=n.axesTCZYX[1],e=t<0?1:n.scaleLevels[0].shape[t];return Array.from({length:e},(i,r)=>`Channel ${r+n.channelOffset}`)}const wo=([n,t,e])=>2+ +(n>-1)+ +(t>-1)+ +(e>-1);function bo(n){const t=[-1,-1,-1,-1,-1],e=["t","c","z","y","x"];n.forEach((i,r)=>{const a=e.indexOf(i.name);if(a>-1)t[a]=r;else throw new B(`Unrecognized axis in zarr: ${i.name}`,{type:P.INVALID_METADATA})});const s=t[4]===-1;if(s||t[3]===-1)throw new B(`Did not find ${s?"an X":"a Y"} axis in zarr`,{type:P.INVALID_METADATA});return t}function So(n,t){const e=wo(t),s=Array(e);return t.forEach((i,r)=>{if(i>=0){if(i>=e)throw new B(`Unexpected axis index in zarr: ${i}`,{type:P.INVALID_METADATA});s[i]=n[r]}}),s}function Jn(n,t,e){const s=[e,e,e,e,e];return t.forEach((i,r)=>{if(i>=0){if(i>=n.length)throw new B(`Unexpected axis index in zarr: ${i}`,{type:P.INVALID_METADATA});s[r]=n[i]}}),s}function vs(n,t){const e=n.coordinateTransformations;if(e===void 0)return console.warn("WARNING: OMEZarrLoader: no coordinate transformations for scale level."),[1,1,1,1,1];const s=a=>a.type==="scale",i=e.find(s);if(!i)return console.warn('WARNING: OMEZarrLoader: no coordinate transformation of type "scale" for scale level.'),[1,1,1,1,1];const r=i.scale.slice();return Jn(r,t,1)}function sn(n,t,e,s){const i=t[2]>-1?n.shape[t[2]]:1,r=s[2]>-1?e.shape[s[2]]:1,a=i-r,o=n.shape[t[3]]-e.shape[s[3]],h=n.shape[t[4]]-e.shape[s[4]];return a===0&&o===0&&h===0?0:a<=0&&o<=0&&h<=0?-1:a>=0&&o>=0&&h>=0?1:void 0}const Ao=1e-5,bs=(n,t)=>Math.abs(n-t)<Ao;function Mo(n,t,e,s){const i=vs(n.multiscaleMetadata.datasets[t],n.axesTCZYX),r=vs(e.multiscaleMetadata.datasets[s],e.axesTCZYX);return bs(i[2],r[2])&&bs(i[3],r[3])&&bs(i[4],r[4])}function zo(n){if(n.length<2)return;const t=Array.from({length:n.length},()=>[]),e=Array.from({length:n.length},()=>[]),s=new Array(n.length).fill(0);for(;s.every((i,r)=>i<n[r].scaleLevels.length);){let i=!0,r=0,a=n[0],o=a.scaleLevels[s[0]];for(let h=1;h<n.length;h++){const l=n[h],c=l.scaleLevels[s[h]],u=sn(o,a.axesTCZYX,c,l.axesTCZYX);if(u)i=!1,u>0&&(r=h,a=l,o=c);else{if(u===void 0)throw new B("Incompatible zarr arrays: pixel dimensions are mismatched",{type:P.INVALID_MULTI_SOURCE_ZARR});Mo(a,s[r],l,s[h])||console.warn("Incompatible zarr arrays: scale levels of equal size have different scale transformations");const d=a.axesTCZYX[0]>-1?o.shape[a.axesTCZYX[0]]:1,f=l.axesTCZYX[0]>-1?c.shape[l.axesTCZYX[0]]:1;d!==f&&console.warn(`Incompatible zarr arrays: different numbers of timesteps: ${d} vs ${f}`)}}if(i)for(let h=0;h<s.length;h++){const l=n[h],c=s[h];t[h].push(l.scaleLevels[c]),e[h].push(l.multiscaleMetadata.datasets[c]),s[h]+=1}else for(const[h,l]of s.entries()){const c=n[h],u=c.scaleLevels[l];sn(o,a.axesTCZYX,u,c.axesTCZYX)!==0&&(s[h]+=1)}}if(n[0].scaleLevels.length===0)throw new B("Incompatible zarr arrays: no sets of scale levels found that matched in all sources",{type:P.INVALID_MULTI_SOURCE_ZARR});for(let i=0;i<n.length;i++)n[i].scaleLevels=t[i],n[i].multiscaleMetadata.datasets=e[i]}function Eo(n,t,e,s){const r=(t.endsWith("/")?t.slice(0,-1):t)+n.path+(n.path.endsWith("/")?"":"/"),a=async(o,h)=>{h!=null&&h.subscriber&&h.reportChunk&&h.reportChunk(o,h.subscriber);const l=r+o.join(","),c=e==null?void 0:e.get(l);if(c&&Mn(c))return c;let u;return s&&(h!=null&&h.subscriber)?u=await s.addRequest(l,h==null?void 0:h.subscriber,()=>n.getChunk(o,h),h.isPrefetch):u=await n.getChunk(o,h),e==null||e.insert(l,u),u};return new Proxy(n,{get:(o,h)=>{if(h==="getChunk")return a;const l=o[h];return l instanceof Function?function(...c){return l.apply(o,c)}:l}})}class Io extends $n{constructor(t,e){super(t,e)}async get(t,e={}){var s;try{return await super.get(t,e)}catch(i){if((s=i==null?void 0:i.message)!=null&&s.startsWith("Unexpected response status 403"))return;throw i}}}const To=n=>n.ome??n;function Qn(n,t){return typeof n=="object"&&n!==null&&t in n}function oe(n,t,e="zarr"){if(!Qn(n,t))throw new B(`${e} metadata is missing required entry "${t}"`,{type:P.INVALID_METADATA})}function Ps(n,t,e="zarr"){if(!Array.isArray(n[t]))throw new B(`${e} metadata entry "${t}" is not an array`,{type:P.INVALID_METADATA})}function Co(n,t="zarr"){oe(n,"multiscales",t),Ps(n,"multiscales",t)}function Do(n,t=0,e="zarr"){const s=n.multiscales[t];if(!s)throw new B(`${e} metadata does not have requested multiscale level ${t}`,{type:P.INVALID_METADATA});const i=Qn(s,"name")?` ("${s.name})`:"",r=`${e} multiscale ${t}${i}`;oe(s,"axes",r),Ps(s,"axes",r),s.axes.forEach((a,o)=>oe(a,"name",`${r} axis ${o}`)),oe(s,"datasets",e),Ps(s,"datasets",e),s.datasets.forEach((a,o)=>oe(a,"path",`${r} dataset ${o}`))}const{slice:Ss}=Wa,re="chunk request cancelled";function ko(n,t){let e=n[0],s=n[0];for(let i=0;i<n.length;i++){const r=n[i];r<e&&(e=r),r>s&&(s=r)}if(t==="float64"){const i=new Float32Array(n.length);for(let r=0;r<n.length;r++)i[r]=n[r];t="float32",n=i}return{data:n,dtype:t,min:e,max:s}}const Ro={maxPrefetchDistance:[5,5,5,5],maxPrefetchChunks:30};class ei extends rs{constructor(t,e,s=Ro,i=[]){super(),this.sources=t,this.requestQueue=e,this.fetchOptions=s,this.priorityDirections=i,this.syncChannels=!1}static async createLoader(t,e=0,s,i,r){var d;i||(i=new jn(r==null?void 0:r.concurrencyLimit,r==null?void 0:r.prefetchConcurrencyLimit));const a=Array.isArray(t)?t:[t],o=Array.isArray(e)?e:[e],h=a.map(async(f,m)=>{var D;const y=new Io(f),p=On(y),g=await ot(p,{kind:"group"}).catch(Yt(`Failed to open OME-Zarr data at ${f}`,P.NOT_FOUND)),x=a.length>1?`Zarr source ${m}`:"Zarr",_=To(g.attrs);Co(_,x);let S=o[Math.min(m,o.length-1)];S>((D=_.multiscales)==null?void 0:D.length)&&(console.warn(`WARNING: OMEZarrLoader: scene ${S} is invalid. Using scene 0.`),S=0),Do(_,S,x);const{multiscales:w,omero:A}=_,M=w[S],I=M.datasets.map(({path:C})=>ot(p.resolve(C),{kind:"array"}).then(R=>Eo(R,f,s,i)).catch(Yt(`Failed to open scale level ${C} of OME-Zarr data at ${f}`,P.NOT_FOUND))),q=await Promise.all(I),V=bo(M.axes);return{scaleLevels:q,multiscaleMetadata:M,omeroMetadata:A,axesTCZYX:V,channelOffset:0}}),l=await Promise.all(h);let c=0;for(const f of l)f.channelOffset=c,c+=((d=f.omeroMetadata)==null?void 0:d.channels.length)??f.scaleLevels[0].shape[f.axesTCZYX[1]];zo(l);const u=r!=null&&r.priorityDirections?r.priorityDirections.slice():void 0;return new ei(l,i,r,u)}getUnitSymbols(){const t=this.sources[0],e=t.axesTCZYX[4],s=t.multiscaleMetadata.axes[e].unit,i=Ji(s)||s||"",r=t.axesTCZYX[0],a=r>-1?t.multiscaleMetadata.axes[r].unit:void 0,o=Ji(a)||a||"";return[i,o]}getLevelShapesZYX(){const t=this.sources[0],[e,s,i]=t.axesTCZYX.slice(-3);return t.scaleLevels.map(({shape:r})=>[e===-1?1:r[e],r[s],r[i]])}getScale(t){return vs(this.sources[0].multiscaleMetadata.datasets[t],this.sources[0].axesTCZYX)}orderByDimension(t,e=0){return So(t,this.sources[e].axesTCZYX)}orderByTCZYX(t,e,s=0){return Jn(t,this.sources[s].axesTCZYX,e)}matchChannelToSource(t){const e=this.sources.length-1,s=this.sources[e],i=s.scaleLevels[0].shape[s.axesTCZYX[1]],r=s.channelOffset+i;if(t>r)throw new B(`Volume channel index ${t} out of range (${r} channels available)`,{type:P.INVALID_METADATA});const a=this.sources.findIndex(l=>l.channelOffset>t),o=a===-1?e:a-1,h=t-this.sources[o].channelOffset;return{sourceIndex:o,channelIndexInSource:h}}setPrefetchPriority(t){this.priorityDirections=t}syncMultichannelLoading(t){this.syncChannels=t}updateFetchOptions(t){this.fetchOptions={...this.fetchOptions,...t}}loadDims(t){const[e,s]=this.getUnitSymbols(),i=this.maxExtent??new it(new b(0,0,0),new b(1,1,1)),a=en(t.subregion,i).getSize(new b),o=[1,1,a.z,a.y,a.x],h=this.sources[0].scaleLevels.map((l,c)=>{const u=this.getScale(c);return{spaceUnit:e,timeUnit:s,shape:this.orderByTCZYX(l.shape,1).map((f,m)=>Math.max(Math.ceil(f*o[m]),1)),spacing:this.orderByTCZYX(u,1),dataType:l.dtype}});return Promise.resolve(h)}createImageInfo(t){var V;const e=this.sources[0],[s,,i,r,a]=e.axesTCZYX,o=s>-1,h=i>-1,l=Qi(t,this.getLevelShapesZYX()),c=e.scaleLevels[l].shape,[u,d]=this.getUnitSymbols(),f=this.sources[this.sources.length-1],m=f.axesTCZYX[1],y=m>-1,p=f.channelOffset+(y?f.scaleLevels[l].shape[m]:1);let g=1;if(o){g=c[s];for(let D=0;D<this.sources.length;D++){const C=this.sources[D].scaleLevels[l].shape,R=this.sources[D].axesTCZYX[0];C[R]<g&&(console.warn("The number of time points is not consistent across sources: ",C[R],g),g=C[R])}}this.maxExtent||(this.maxExtent=t.subregion.clone());const _=tn(t.subregion,new b(c[a],c[r],h?c[i]:1)).getSize(new b),S=ce(_.z,_.x,_.y),w=new Map,A=this.sources.flatMap(D=>_o(D).map(R=>{const j=w.get(R);return j!==void 0?(w.set(R,j+1),`${R} (${j})`):(w.set(R,1),R)})),M=e.scaleLevels.map((D,C)=>({spaceUnit:u,timeUnit:d,shape:this.orderByTCZYX(D.shape,1),spacing:this.getScale(C),dataType:D.dtype})),I={name:((V=e.omeroMetadata)==null?void 0:V.name)||"Volume",atlasTileDims:[S.x,S.y],subregionSize:[_.x,_.y,_.z],subregionOffset:[0,0,0],combinedNumChannels:p,channelNames:A,multiscaleLevel:l,multiscaleLevelDims:M,transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},q={...t,subregion:new it(new b(0,0,0),new b(1,1,1))};return Promise.resolve({imageInfo:I,loadSpec:q})}prefetchChunk(t,e,s){t.getChunk(this.orderByDimension(e),{subscriber:s,isPrefetch:!0}).catch(Yt(`Unable to prefetch chunk with coords ${e.join(", ")}`,P.LOAD_DATA_FAILED,re))}beginPrefetch(t,e){if(t.length===0)return;const s=t.map(({sourceIdx:h,coords:l})=>{const c=this.orderByTCZYX(l,0,h);return c[1]+=this.sources[h].channelOffset,c}),i=this.sources.map(h=>{const l=h.scaleLevels[e],c=l.shape.map((u,d)=>Math.ceil(u/l.chunks[d]));return this.orderByTCZYX(c,1)}),r=new Je(s,this.fetchOptions.maxPrefetchDistance,i,this.priorityDirections,this.fetchOptions.onlyPriorityDirections),a=this.requestQueue.addSubscriber();let o=0;for(const h of r){if(o>=this.fetchOptions.maxPrefetchChunks)break;const{sourceIndex:l,channelIndexInSource:c}=this.matchChannelToSource(h[1]),u=this.sources[l].scaleLevels[e];h[1]=c,this.prefetchChunk(u,h,a),o++}this.prefetchSubscriber!==void 0&&this.requestQueue.removeSubscriber(this.prefetchSubscriber,re),this.prefetchSubscriber=a}updateImageInfoForLoad(t,e){const s=this.maxExtent??new it(new b(0,0,0),new b(1,1,1)),i=en(e.subregion,s),r=Qi({...e,subregion:i},this.getLevelShapesZYX()),a=this.sources[0].scaleLevels[r].shape,[o,h,l]=this.sources[0].axesTCZYX.slice(2),c=tn(i,new b(a[l],a[h],o===-1?1:a[o])),u=c.getSize(new b),d=ce(u.z,u.x,u.y);return{...t,atlasTileDims:[d.x,d.y],subregionSize:[u.x,u.y,u.z],subregionOffset:[c.min.x,c.min.y,c.min.z],multiscaleLevel:r}}async loadRawChannelData(t,e,s,i){const r=this.syncChannels,a=this.updateImageInfoForLoad(t,e);s(a);const{combinedNumChannels:o,multiscaleLevel:h}=a,l=e.channels??Array.from({length:o},(x,_)=>_),c=this.requestQueue.addSubscriber(),u=[],d=(x,_,S)=>{S===c&&u.push({sourceIdx:x,coords:_})},f=[],m=[],y=[],p=[],g=l.map(async x=>{const _=new b(...a.subregionOffset),S=_.clone().add(new b(...a.subregionSize)),{sourceIndex:w,channelIndexInSource:A}=this.matchChannelToSource(x),M=[e.time,A,Ss(_.z,S.z),Ss(_.y,S.y),Ss(_.x,S.x)],I=this.sources[w].scaleLevels[h],q=this.orderByDimension(M,w),V=(R,j)=>d(w,R,j);console.log(I);const D=await qn(I,q,{opts:{subscriber:c,reportChunk:V}}).catch(Yt("Could not load OME-Zarr volume data",P.LOAD_DATA_FAILED,re));if((D==null?void 0:D.data)===void 0)return;const C=ko(D.data,I.dtype);r?(y.push(C.dtype),m.push(C.data),f.push(x),p.push([C.min,C.max])):i([x],[C.dtype],[C.data],[[C.min,C.max]])});this.loadSubscriber!==void 0&&this.requestQueue.removeSubscriber(this.loadSubscriber,re),this.loadSubscriber=c,this.beginPrefetch(u,h),await Promise.all(g),r&&i(f,y,m,p),this.requestQueue.removeSubscriber(c,re)}}var Vt=(n=>(n[n.MILLISECOND=0]="MILLISECOND",n[n.SECOND=1]="SECOND",n[n.MINUTE=2]="MINUTE",n[n.HOUR=3]="HOUR",n[n.DAY=4]="DAY",n))(Vt||{});const tr=1e3,er=tr*60,sr=er*60,Oo=sr*24;Vt.MILLISECOND+"",Vt.SECOND+"",Vt.MINUTE+"",Vt.HOUR+"",Vt.DAY+"";function Ns(n){let t=n[0],e=n[0];for(let s=1;s<n.length;s++)t=Math.min(t,n[s]),e=Math.max(e,n[s]);return[t,e]}const ir=n=>{const t=n.pixel_size_x*n.width/n.tile_width,e=n.pixel_size_y*n.height/n.tile_height,s=n.pixel_size_z;return[t,e,s]},Lo=n=>{var r,a;const[t,e,s]=ir(n),i=((r=n.transform)==null?void 0:r.translation)??[0,0,0];return i[0]=i[0]*n.tile_width/n.width,i[1]=i[1]*n.tile_height/n.height,{name:n.name,atlasTileDims:[n.cols,n.rows],subregionSize:[n.tile_width,n.tile_height,n.tiles],subregionOffset:[0,0,0],combinedNumChannels:n.channels,channelNames:n.channel_names,channelColors:n.channel_colors,multiscaleLevel:0,multiscaleLevelDims:[{shape:[n.times||1,n.channels,n.tiles,n.tile_height,n.tile_width],spacing:[n.time_scale||1,1,s,e,t],spaceUnit:n.pixel_size_unit||"m",timeUnit:n.time_unit||"s",dataType:"uint8"}],transform:{translation:i,rotation:(a=n.transform)!=null&&a.rotation?n.transform.rotation:[0,0,0],scale:[1,1,1]},userData:{...n.userData,originalVolumeSize:[n.width,n.height,n.tiles],originalPhysicalPixelSize:[n.pixel_size_x,n.pixel_size_y,n.pixel_size_z]}}};class si extends rs{constructor(t,e){super(),this.syncChannels=!1,Array.isArray(t)?this.urls=t:this.urls=[t],this.jsonInfo=new Array(this.urls.length),this.cache=e}async getJsonImageInfo(t){const e=this.jsonInfo[t];if(e)return e;const i=await(await fetch(this.urls[t])).json();return i.pixel_size_unit=i.pixel_size_unit||"m",i.times=i.times||this.urls.length,this.jsonInfo[t]=i,i}syncMultichannelLoading(t){this.syncChannels=t}async loadDims(t){const e=await this.getJsonImageInfo(t.time),[s,i,r]=ir(e);return[{shape:[e.times||1,e.channels,e.tiles,e.tile_height,e.tile_width],spacing:[1,1,r,i,s],spaceUnit:e.pixel_size_unit??"m",dataType:"uint8",timeUnit:e.time_unit??"s"}]}async createImageInfo(t){const e=await this.getJsonImageInfo(t.time);return{imageInfo:Lo(e),loadSpec:t}}async loadRawChannelData(t,e,s,i){const r=await this.getJsonImageInfo(e.time);let a=r==null?void 0:r.images;if(!a)return;const o=e.channels;o&&(a=a.filter(({channels:f})=>f.some(m=>o.includes(m))));const h=this.urls[e.time].replace(/[^/]*$/,"");a=a.map(f=>({...f,name:h+f.name}));const l={...e,subregion:new it(new b(0,0,0),new b(1,1,1)),multiscaleLevel:0,channels:a.flatMap(({channels:f})=>f)};s(void 0,l);const[c,u]=ho(t),d=(f,m,y,p)=>i(f,m,y,p,[c,u]);await si.loadVolumeAtlasData(a,d,this.cache,this.syncChannels)}static async loadVolumeAtlasData(t,e,s,i=!1){const r=[],a=[],o=[],h=[],l=t.map(async c=>{let u=!0;for(let w=0;w<Math.min(c.channels.length,4);++w){const A=c.channels[w],M=s==null?void 0:s.get(`${c.name}/${A}`);if(M&&!Mn(M)){const I=new Uint8Array(M);i?(r.push(A),a.push("uint8"),o.push(I),h.push(Ns(I))):e([A],["uint8"],[I],[Ns(I)])}else{u=!1;break}}if(u)return;const f=await(await fetch(c.name,{mode:"cors"})).blob(),m=await createImageBitmap(f),p=new OffscreenCanvas(m.width,m.height).getContext("2d");if(!p){console.log("Error creating canvas 2d context for "+c.name);return}p.globalCompositeOperation="copy",p.globalAlpha=1,p.drawImage(m,0,0);const g=p.getImageData(0,0,m.width,m.height),x=[],_=m.width*m.height;for(let w=0;w<Math.min(c.channels.length,4);++w)x.push(new Uint8Array(_));const S=[];for(let w=0;w<Math.min(c.channels.length,4);++w){let A=1/0,M=-1/0;for(let I=0;I<_;I++)x[w][I]=g.data[I*4+w],A=Math.min(A,x[w][I]),M=Math.max(M,x[w][I]);S[w]=[A,M]}for(let w=0;w<Math.min(c.channels.length,4);++w){const A=c.channels[w];s==null||s.insert(`${c.name}/${A}`,x[w]),i?(r.push(A),a.push("uint8"),o.push(x[w]),h.push(S[w])):e([A],["uint8"],[x[w]],[S[w]],[m.width,m.height])}});await Promise.all(l),i&&e(r,a,o,h)}}const vo=n=>{const t=ce(n.sizeZ,n.sizeX,n.sizeY);return{name:n.name,atlasTileDims:[t.x,t.y],subregionSize:[n.sizeX,n.sizeY,n.sizeZ],subregionOffset:[0,0,0],combinedNumChannels:n.sizeC,channelNames:n.channelNames,channelColors:void 0,multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,n.sizeC,n.sizeZ,n.sizeY,n.sizeX],spacing:[1,1,n.physicalPixelSize[2],n.physicalPixelSize[1],n.physicalPixelSize[0]],spaceUnit:n.spatialUnit||"m",timeUnit:"s",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},userData:n.userData}};class Po extends rs{constructor(t,e){if(super(),this.jsonInfo=e,this.data=t,this.data.shape[0]!==this.jsonInfo.sizeC||this.data.shape[1]!==this.jsonInfo.sizeZ||this.data.shape[2]!==this.jsonInfo.sizeY||this.data.shape[3]!==this.jsonInfo.sizeX)throw new Error("RawArrayLoader: data shape does not match metadata")}async loadDims(t){const e=this.jsonInfo;return[{shape:[1,e.sizeC,e.sizeZ,e.sizeY,e.sizeX],spacing:[1,1,e.physicalPixelSize[2],e.physicalPixelSize[1],e.physicalPixelSize[0]],spaceUnit:e.spatialUnit||"m",dataType:"uint8",timeUnit:"s"}]}async createImageInfo(t){return{imageInfo:vo(this.jsonInfo),loadSpec:t}}loadRawChannelData(t,e,s,i){const r=e.channels,a={...e,subregion:new it(new b(0,0,0),new b(1,1,1)),multiscaleLevel:0};s(void 0,a);for(let o=0;o<t.combinedNumChannels;++o){if(r&&r.length>0&&!r.includes(o))continue;const h=this.data.shape[3]*this.data.shape[2]*this.data.shape[1],l=new Uint8Array(this.data.buffer.buffer,o*h,h),c=Ns(l);i([o],["uint8"],[l],[c])}return Promise.resolve()}}function N(n){return(t,...e)=>No(n,t,e)}function Qt(n,t){return N(nr(n,t).get)}const{apply:No,getOwnPropertyDescriptor:nr,getPrototypeOf:ii,ownKeys:Uo}=Reflect,{iterator:Te,toStringTag:Fo}=Symbol,Bo=Object,{create:ni,defineProperty:qo}=Bo,Vo=Array,Go=Vo.prototype,rr=Go[Te],Yo=N(rr),ar=ArrayBuffer,$o=ar.prototype;Qt($o,"byteLength");const nn=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;nn&&Qt(nn.prototype,"byteLength");const or=ii(Uint8Array);or.from;const G=or.prototype;G[Te];N(G.keys);N(G.values);N(G.entries);N(G.set);N(G.reverse);N(G.fill);N(G.copyWithin);N(G.sort);N(G.slice);N(G.subarray);Qt(G,"buffer");Qt(G,"byteOffset");Qt(G,"length");Qt(G,Fo);const Xo=Uint8Array,hr=Uint16Array,ri=Uint32Array,jo=Float32Array,ue=ii([][Te]()),lr=N(ue.next),Ho=N(function*(){}().next),Zo=ii(ue),Ko=DataView.prototype,Wo=N(Ko.getUint16),ai=WeakMap,cr=ai.prototype,ur=N(cr.get),Jo=N(cr.set),fr=new ai,Qo=ni(null,{next:{value:function(){const t=ur(fr,this);return lr(t)}},[Te]:{value:function(){return this}}});function th(n){if(n[Te]===rr&&ue.next===lr)return n;const t=ni(Qo);return Jo(fr,t,Yo(n)),t}const eh=new ai,sh=ni(Zo,{next:{value:function(){const t=ur(eh,this);return Ho(t)},writable:!0,configurable:!0}});for(const n of Uo(ue))n!=="next"&&qo(sh,n,nr(ue,n));const dr=new ar(4),ih=new jo(dr),nh=new ri(dr),J=new hr(512),Q=new Xo(512);for(let n=0;n<256;++n){const t=n-127;t<-24?(J[n]=0,J[n|256]=32768,Q[n]=24,Q[n|256]=24):t<-14?(J[n]=1024>>-t-14,J[n|256]=1024>>-t-14|32768,Q[n]=-t-1,Q[n|256]=-t-1):t<=15?(J[n]=t+15<<10,J[n|256]=t+15<<10|32768,Q[n]=13,Q[n|256]=13):t<128?(J[n]=31744,J[n|256]=64512,Q[n]=24,Q[n|256]=24):(J[n]=31744,J[n|256]=64512,Q[n]=13,Q[n|256]=13)}const oi=new ri(2048);for(let n=1;n<1024;++n){let t=n<<13,e=0;for(;(t&8388608)===0;)t<<=1,e-=8388608;t&=-8388609,e+=947912704,oi[n]=t|e}for(let n=1024;n<2048;++n)oi[n]=939524096+(n-1024<<13);const te=new ri(64);for(let n=1;n<31;++n)te[n]=n<<23;te[31]=1199570944;te[32]=2147483648;for(let n=33;n<63;++n)te[n]=2147483648+(n-32<<23);te[63]=3347054592;const mr=new hr(64);for(let n=1;n<64;++n)n!==32&&(mr[n]=1024);function rh(n){const t=n>>10;return nh[0]=oi[mr[t]+(n&1023)]+te[t],ih[0]}function yr(n,t,...e){return rh(Wo(n,t,...th(e)))}function pr(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Be={exports:{}},rn;function ah(){if(rn)return Be.exports;rn=1;function n(t,e,s){const i=s&&s.debug||!1;i&&console.log("[xml-utils] getting "+e+" in "+t);const r=typeof t=="object"?t.outer:t,a=r.slice(0,r.indexOf(">")+1),o=['"',"'"];for(let h=0;h<o.length;h++){const l=o[h],c=e+"\\="+l+"([^"+l+"]*)"+l;i&&console.log("[xml-utils] pattern:",c);const d=new RegExp(c).exec(a);if(i&&console.log("[xml-utils] match:",d),d)return d[1]}}return Be.exports=n,Be.exports.default=n,Be.exports}var oh=ah(),As=pr(oh),qe={exports:{}},Ve={exports:{}},Ge={exports:{}},an;function hh(){if(an)return Ge.exports;an=1;function n(t,e,s){const r=new RegExp(e).exec(t.slice(s));return r?s+r.index:-1}return Ge.exports=n,Ge.exports.default=n,Ge.exports}var Ye={exports:{}},on;function lh(){if(on)return Ye.exports;on=1;function n(t,e,s){const r=new RegExp(e).exec(t.slice(s));return r?s+r.index+r[0].length-1:-1}return Ye.exports=n,Ye.exports.default=n,Ye.exports}var $e={exports:{}},hn;function ch(){if(hn)return $e.exports;hn=1;function n(t,e){const s=new RegExp(e,"g"),i=t.match(s);return i?i.length:0}return $e.exports=n,$e.exports.default=n,$e.exports}var ln;function uh(){if(ln)return Ve.exports;ln=1;const n=hh(),t=lh(),e=ch();function s(i,r,a){const o=a&&a.debug||!1,h=!(a&&typeof a.nested===!1),l=a&&a.startIndex||0;o&&console.log("[xml-utils] starting findTagByName with",r," and ",a);const c=n(i,`<${r}[ 
>/]`,l);if(o&&console.log("[xml-utils] start:",c),c===-1)return;const u=i.slice(c+r.length);let d=t(u,"^[^<]*[ /]>",0);const f=d!==-1&&u[d-1]==="/";if(o&&console.log("[xml-utils] selfClosing:",f),f===!1)if(h){let g=0,x=1,_=0;for(;(d=t(u,"[ /]"+r+">",g))!==-1;){const S=u.substring(g,d+1);if(x+=e(S,"<"+r+`[ 
	>]`),_+=e(S,"</"+r+">"),_>=x)break;g=d}}else d=t(u,"[ /]"+r+">",0);const m=c+r.length+d+1;if(o&&console.log("[xml-utils] end:",m),m===-1)return;const y=i.slice(c,m);let p;return f?p=null:p=y.slice(y.indexOf(">")+1,y.lastIndexOf("<")),{inner:p,outer:y,start:c,end:m}}return Ve.exports=s,Ve.exports.default=s,Ve.exports}var cn;function fh(){if(cn)return qe.exports;cn=1;const n=uh();function t(e,s,i){const r=[],a=i&&i.debug||!1,o=i&&typeof i.nested=="boolean"?i.nested:!0;let h=i&&i.startIndex||0,l;for(;l=n(e,s,{debug:a,startIndex:h});)o?h=l.start+1+s.length:h=l.end,r.push(l);return a&&console.log("findTagsByName found",r.length,"tags"),r}return qe.exports=t,qe.exports.default=t,qe.exports}var dh=fh(),mh=pr(dh);const he={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},tt={};for(const n in he)he.hasOwnProperty(n)&&(tt[he[n]]=parseInt(n,10));const yh=[tt.BitsPerSample,tt.ExtraSamples,tt.SampleFormat,tt.StripByteCounts,tt.StripOffsets,tt.StripRowCounts,tt.TileByteCounts,tt.TileOffsets,tt.SubIFDs],Ms={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},E={};for(const n in Ms)Ms.hasOwnProperty(n)&&(E[Ms[n]]=parseInt(n,10));const $={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8},ph={Unspecified:0},wl={AddCompression:1},bl={None:0,Deflate:1,Zstandard:2},gh={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function xh(n,t){const{width:e,height:s}=n,i=new Uint8Array(e*s*3);let r;for(let a=0,o=0;a<n.length;++a,o+=3)r=256-n[a]/t*256,i[o]=r,i[o+1]=r,i[o+2]=r;return i}function _h(n,t){const{width:e,height:s}=n,i=new Uint8Array(e*s*3);let r;for(let a=0,o=0;a<n.length;++a,o+=3)r=n[a]/t*256,i[o]=r,i[o+1]=r,i[o+2]=r;return i}function wh(n,t){const{width:e,height:s}=n,i=new Uint8Array(e*s*3),r=t.length/3,a=t.length/3*2;for(let o=0,h=0;o<n.length;++o,h+=3){const l=n[o];i[h]=t[l]/65536*256,i[h+1]=t[l+r]/65536*256,i[h+2]=t[l+a]/65536*256}return i}function bh(n){const{width:t,height:e}=n,s=new Uint8Array(t*e*3);for(let i=0,r=0;i<n.length;i+=4,r+=3){const a=n[i],o=n[i+1],h=n[i+2],l=n[i+3];s[r]=255*((255-a)/256)*((255-l)/256),s[r+1]=255*((255-o)/256)*((255-l)/256),s[r+2]=255*((255-h)/256)*((255-l)/256)}return s}function Sh(n){const{width:t,height:e}=n,s=new Uint8ClampedArray(t*e*3);for(let i=0,r=0;i<n.length;i+=3,r+=3){const a=n[i],o=n[i+1],h=n[i+2];s[r]=a+1.402*(h-128),s[r+1]=a-.34414*(o-128)-.71414*(h-128),s[r+2]=a+1.772*(o-128)}return s}const Ah=.95047,Mh=1,zh=1.08883;function Eh(n){const{width:t,height:e}=n,s=new Uint8Array(t*e*3);for(let i=0,r=0;i<n.length;i+=3,r+=3){const a=n[i+0],o=n[i+1]<<24>>24,h=n[i+2]<<24>>24;let l=(a+16)/116,c=o/500+l,u=l-h/200,d,f,m;c=Ah*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),l=Mh*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),u=zh*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),d=c*3.2406+l*-1.5372+u*-.4986,f=c*-.9689+l*1.8758+u*.0415,m=c*.0557+l*-.204+u*1.057,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,m=m>.0031308?1.055*m**(1/2.4)-.055:12.92*m,s[r]=Math.max(0,Math.min(1,d))*255,s[r+1]=Math.max(0,Math.min(1,f))*255,s[r+2]=Math.max(0,Math.min(1,m))*255}return s}const gr=new Map;function wt(n,t){Array.isArray(n)||(n=[n]),n.forEach(e=>gr.set(e,t))}async function Ih(n){const t=gr.get(n.Compression);if(!t)throw new Error(`Unknown compression method identifier: ${n.Compression}`);const e=await t();return new e(n)}wt([void 0,1],()=>import("./raw-in9isEBO.js").then(n=>n.default));wt(5,()=>import("./lzw-_aCqfs4w.js").then(n=>n.default));wt(6,()=>{throw new Error("old style JPEG compression is not supported.")});wt(7,()=>import("./jpeg-CKYXsxFN.js").then(n=>n.default));wt([8,32946],()=>import("./deflate-B9JhHpvg.js").then(n=>n.default));wt(32773,()=>import("./packbits-DDWKfGV_.js").then(n=>n.default));wt(34887,()=>import("./lerc-DL1cJuBN.js").then(async n=>(await n.zstd.init(),n)).then(n=>n.default));wt(50001,()=>import("./webimage-DBgUwIbt.js").then(n=>n.default));function as(n,t,e,s=1){return new(Object.getPrototypeOf(n)).constructor(t*e*s)}function Th(n,t,e,s,i){const r=t/s,a=e/i;return n.map(o=>{const h=as(o,s,i);for(let l=0;l<i;++l){const c=Math.min(Math.round(a*l),e-1);for(let u=0;u<s;++u){const d=Math.min(Math.round(r*u),t-1),f=o[c*t+d];h[l*s+u]=f}}return h})}function $t(n,t,e){return(1-e)*n+e*t}function Ch(n,t,e,s,i){const r=t/s,a=e/i;return n.map(o=>{const h=as(o,s,i);for(let l=0;l<i;++l){const c=a*l,u=Math.floor(c),d=Math.min(Math.ceil(c),e-1);for(let f=0;f<s;++f){const m=r*f,y=m%1,p=Math.floor(m),g=Math.min(Math.ceil(m),t-1),x=o[u*t+p],_=o[u*t+g],S=o[d*t+p],w=o[d*t+g],A=$t($t(x,_,y),$t(S,w,y),c%1);h[l*s+f]=A}}return h})}function Dh(n,t,e,s,i,r="nearest"){switch(r.toLowerCase()){case"nearest":return Th(n,t,e,s,i);case"bilinear":case"linear":return Ch(n,t,e,s,i);default:throw new Error(`Unsupported resampling method: '${r}'`)}}function kh(n,t,e,s,i,r){const a=t/s,o=e/i,h=as(n,s,i,r);for(let l=0;l<i;++l){const c=Math.min(Math.round(o*l),e-1);for(let u=0;u<s;++u){const d=Math.min(Math.round(a*u),t-1);for(let f=0;f<r;++f){const m=n[c*t*r+d*r+f];h[l*s*r+u*r+f]=m}}}return h}function Rh(n,t,e,s,i,r){const a=t/s,o=e/i,h=as(n,s,i,r);for(let l=0;l<i;++l){const c=o*l,u=Math.floor(c),d=Math.min(Math.ceil(c),e-1);for(let f=0;f<s;++f){const m=a*f,y=m%1,p=Math.floor(m),g=Math.min(Math.ceil(m),t-1);for(let x=0;x<r;++x){const _=n[u*t*r+p*r+x],S=n[u*t*r+g*r+x],w=n[d*t*r+p*r+x],A=n[d*t*r+g*r+x],M=$t($t(_,S,y),$t(w,A,y),c%1);h[l*s*r+f*r+x]=M}}}return h}function Oh(n,t,e,s,i,r,a="nearest"){switch(a.toLowerCase()){case"nearest":return kh(n,t,e,s,i,r);case"bilinear":case"linear":return Rh(n,t,e,s,i,r);default:throw new Error(`Unsupported resampling method: '${a}'`)}}function Lh(n,t,e){let s=0;for(let i=t;i<e;++i)s+=n[i];return s}function Us(n,t,e){switch(n){case 1:if(t<=8)return new Uint8Array(e);if(t<=16)return new Uint16Array(e);if(t<=32)return new Uint32Array(e);break;case 2:if(t===8)return new Int8Array(e);if(t===16)return new Int16Array(e);if(t===32)return new Int32Array(e);break;case 3:switch(t){case 16:case 32:return new Float32Array(e);case 64:return new Float64Array(e)}break}throw Error("Unsupported data format/bitsPerSample")}function vh(n,t){return(n===1||n===2)&&t<=32&&t%8===0?!1:!(n===3&&(t===16||t===32||t===64))}function Ph(n,t,e,s,i,r,a){const o=new DataView(n),h=e===2?a*r:a*r*s,l=e===2?1:s,c=Us(t,i,h),u=parseInt("1".repeat(i),2);if(t===1){let d;e===1?d=s*i:d=i;let f=r*d;(f&7)!==0&&(f=f+7&-8);for(let m=0;m<a;++m){const y=m*f;for(let p=0;p<r;++p){const g=y+p*l*i;for(let x=0;x<l;++x){const _=g+x*i,S=(m*r+p)*l+x,w=Math.floor(_/8),A=_%8;if(A+i<=8)c[S]=o.getUint8(w)>>8-i-A&u;else if(A+i<=16)c[S]=o.getUint16(w)>>16-i-A&u;else if(A+i<=24){const M=o.getUint16(w)<<8|o.getUint8(w+2);c[S]=M>>24-i-A&u}else c[S]=o.getUint32(w)>>32-i-A&u}}}}return c.buffer}class Nh{constructor(t,e,s,i,r,a){this.fileDirectory=t,this.geoKeys=e,this.dataView=s,this.littleEndian=i,this.tiles=r?{}:null,this.isTiled=!t.StripOffsets;const o=t.PlanarConfiguration;if(this.planarConfiguration=typeof o>"u"?1:o,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=a}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(t){return this.isTiled||(t+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-t*this.getTileHeight()}getBytesPerPixel(){let t=0;for(let e=0;e<this.fileDirectory.BitsPerSample.length;++e)t+=this.getSampleByteSize(e);return t}getSampleByteSize(t){if(t>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${t} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[t]/8)}getReaderForSample(t){const e=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1,s=this.fileDirectory.BitsPerSample[t];switch(e){case 1:if(s<=8)return DataView.prototype.getUint8;if(s<=16)return DataView.prototype.getUint16;if(s<=32)return DataView.prototype.getUint32;break;case 2:if(s<=8)return DataView.prototype.getInt8;if(s<=16)return DataView.prototype.getInt16;if(s<=32)return DataView.prototype.getInt32;break;case 3:switch(s){case 16:return function(i,r){return yr(this,i,r)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(t=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1}getBitsPerSample(t=0){return this.fileDirectory.BitsPerSample[t]}getArrayForSample(t,e){const s=this.getSampleFormat(t),i=this.getBitsPerSample(t);return Us(s,i,e)}async getTileOrStrip(t,e,s,i,r){const a=Math.ceil(this.getWidth()/this.getTileWidth()),o=Math.ceil(this.getHeight()/this.getTileHeight());let h;const{tiles:l}=this;this.planarConfiguration===1?h=e*a+t:this.planarConfiguration===2&&(h=s*a*o+e*a+t);let c,u;this.isTiled?(c=this.fileDirectory.TileOffsets[h],u=this.fileDirectory.TileByteCounts[h]):(c=this.fileDirectory.StripOffsets[h],u=this.fileDirectory.StripByteCounts[h]);const d=(await this.source.fetch([{offset:c,length:u}],r))[0];let f;return l===null||!l[h]?(f=(async()=>{let m=await i.decode(this.fileDirectory,d);const y=this.getSampleFormat(),p=this.getBitsPerSample();return vh(y,p)&&(m=Ph(m,y,this.planarConfiguration,this.getSamplesPerPixel(),p,this.getTileWidth(),this.getBlockHeight(e))),m})(),l!==null&&(l[h]=f)):f=l[h],{x:t,y:e,sample:s,data:await f}}async _readRaster(t,e,s,i,r,a,o,h,l){const c=this.getTileWidth(),u=this.getTileHeight(),d=this.getWidth(),f=this.getHeight(),m=Math.max(Math.floor(t[0]/c),0),y=Math.min(Math.ceil(t[2]/c),Math.ceil(d/c)),p=Math.max(Math.floor(t[1]/u),0),g=Math.min(Math.ceil(t[3]/u),Math.ceil(f/u)),x=t[2]-t[0];let _=this.getBytesPerPixel();const S=[],w=[];for(let I=0;I<e.length;++I)this.planarConfiguration===1?S.push(Lh(this.fileDirectory.BitsPerSample,0,e[I])/8):S.push(0),w.push(this.getReaderForSample(e[I]));const A=[],{littleEndian:M}=this;for(let I=p;I<g;++I)for(let q=m;q<y;++q){let V;this.planarConfiguration===1&&(V=this.getTileOrStrip(q,I,0,r,l));for(let D=0;D<e.length;++D){const C=D,R=e[D];this.planarConfiguration===2&&(_=this.getSampleByteSize(R),V=this.getTileOrStrip(q,I,R,r,l));const j=V.then(K=>{const Tt=K.data,Ct=new DataView(Tt),ut=this.getBlockHeight(K.y),W=K.y*u,nt=K.x*c,Dt=W+ut,Sr=(K.x+1)*c,Ar=w[C],Mr=Math.min(ut,ut-(Dt-t[3]),f-W),zr=Math.min(c,c-(Sr-t[2]),d-nt);for(let ee=Math.max(0,t[1]-W);ee<Mr;++ee)for(let se=Math.max(0,t[0]-nt);se<zr;++se){const Er=(ee*c+se)*_,xi=Ar.call(Ct,Er+S[C],M);let Ce;i?(Ce=(ee+W-t[1])*x*e.length+(se+nt-t[0])*e.length+C,s[Ce]=xi):(Ce=(ee+W-t[1])*x+se+nt-t[0],s[C][Ce]=xi)}});A.push(j)}}if(await Promise.all(A),a&&t[2]-t[0]!==a||o&&t[3]-t[1]!==o){let I;return i?I=Oh(s,t[2]-t[0],t[3]-t[1],a,o,e.length,h):I=Dh(s,t[2]-t[0],t[3]-t[1],a,o,h),I.width=a,I.height=o,I}return s.width=a||t[2]-t[0],s.height=o||t[3]-t[1],s}async readRasters({window:t,samples:e=[],interleave:s,pool:i=null,width:r,height:a,resampleMethod:o,fillValue:h,signal:l}={}){const c=t||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const u=c[2]-c[0],d=c[3]-c[1],f=u*d,m=this.getSamplesPerPixel();if(!e||!e.length)for(let x=0;x<m;++x)e.push(x);else for(let x=0;x<e.length;++x)if(e[x]>=m)return Promise.reject(new RangeError(`Invalid sample index '${e[x]}'.`));let y;if(s){const x=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,_=Math.max.apply(null,this.fileDirectory.BitsPerSample);y=Us(x,_,f*e.length),h&&y.fill(h)}else{y=[];for(let x=0;x<e.length;++x){const _=this.getArrayForSample(e[x],f);Array.isArray(h)&&x<h.length?_.fill(h[x]):h&&!Array.isArray(h)&&_.fill(h),y.push(_)}}const p=i||await Ih(this.fileDirectory);return await this._readRaster(c,e,y,s,p,r,a,o,l)}async readRGB({window:t,interleave:e=!0,pool:s=null,width:i,height:r,resampleMethod:a,enableAlpha:o=!1,signal:h}={}){const l=t||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");const c=this.fileDirectory.PhotometricInterpretation;if(c===$.RGB){let g=[0,1,2];if(this.fileDirectory.ExtraSamples!==ph.Unspecified&&o){g=[];for(let x=0;x<this.fileDirectory.BitsPerSample.length;x+=1)g.push(x)}return this.readRasters({window:t,interleave:e,samples:g,pool:s,width:i,height:r,resampleMethod:a,signal:h})}let u;switch(c){case $.WhiteIsZero:case $.BlackIsZero:case $.Palette:u=[0];break;case $.CMYK:u=[0,1,2,3];break;case $.YCbCr:case $.CIELab:u=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const d={window:l,interleave:!0,samples:u,pool:s,width:i,height:r,resampleMethod:a,signal:h},{fileDirectory:f}=this,m=await this.readRasters(d),y=2**this.fileDirectory.BitsPerSample[0];let p;switch(c){case $.WhiteIsZero:p=xh(m,y);break;case $.BlackIsZero:p=_h(m,y);break;case $.Palette:p=wh(m,f.ColorMap);break;case $.CMYK:p=bh(m);break;case $.YCbCr:p=Sh(m);break;case $.CIELab:p=Eh(m);break;default:throw new Error("Unsupported photometric interpretation.")}if(!e){const g=new Uint8Array(p.length/3),x=new Uint8Array(p.length/3),_=new Uint8Array(p.length/3);for(let S=0,w=0;S<p.length;S+=3,++w)g[w]=p[S],x[w]=p[S+1],_[w]=p[S+2];p=[g,x,_]}return p.width=m.width,p.height=m.height,p}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const t=[];for(let e=0;e<this.fileDirectory.ModelTiepoint.length;e+=6)t.push({i:this.fileDirectory.ModelTiepoint[e],j:this.fileDirectory.ModelTiepoint[e+1],k:this.fileDirectory.ModelTiepoint[e+2],x:this.fileDirectory.ModelTiepoint[e+3],y:this.fileDirectory.ModelTiepoint[e+4],z:this.fileDirectory.ModelTiepoint[e+5]});return t}getGDALMetadata(t=null){const e={};if(!this.fileDirectory.GDAL_METADATA)return null;const s=this.fileDirectory.GDAL_METADATA;let i=mh(s,"Item");t===null?i=i.filter(r=>As(r,"sample")===void 0):i=i.filter(r=>Number(As(r,"sample"))===t);for(let r=0;r<i.length;++r){const a=i[r];e[As(a,"name")]=a.inner}return e}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const t=this.fileDirectory.GDAL_NODATA;return Number(t.substring(0,t.length-1))}getOrigin(){const t=this.fileDirectory.ModelTiepoint,e=this.fileDirectory.ModelTransformation;if(t&&t.length===6)return[t[3],t[4],t[5]];if(e)return[e[3],e[7],e[11]];throw new Error("The image does not have an affine transformation.")}getResolution(t=null){const e=this.fileDirectory.ModelPixelScale,s=this.fileDirectory.ModelTransformation;if(e)return[e[0],-e[1],e[2]];if(s)return s[1]===0&&s[4]===0?[s[0],-s[5],s[10]]:[Math.sqrt(s[0]*s[0]+s[4]*s[4]),-Math.sqrt(s[1]*s[1]+s[5]*s[5]),s[10]];if(t){const[i,r,a]=t.getResolution();return[i*t.getWidth()/this.getWidth(),r*t.getHeight()/this.getHeight(),a*t.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(t=!1){const e=this.getHeight(),s=this.getWidth();if(this.fileDirectory.ModelTransformation&&!t){const[i,r,a,o,h,l,c,u]=this.fileDirectory.ModelTransformation,f=[[0,0],[0,e],[s,0],[s,e]].map(([p,g])=>[o+i*p+r*g,u+h*p+l*g]),m=f.map(p=>p[0]),y=f.map(p=>p[1]);return[Math.min(...m),Math.min(...y),Math.max(...m),Math.max(...y)]}else{const i=this.getOrigin(),r=this.getResolution(),a=i[0],o=i[1],h=a+r[0]*s,l=o+r[1]*e;return[Math.min(a,h),Math.min(o,l),Math.max(a,h),Math.max(o,l)]}}}class Uh{constructor(t){this._dataView=new DataView(t)}get buffer(){return this._dataView.buffer}getUint64(t,e){const s=this.getUint32(t,e),i=this.getUint32(t+4,e);let r;if(e){if(r=s+2**32*i,!Number.isSafeInteger(r))throw new Error(`${r} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return r}if(r=2**32*s+i,!Number.isSafeInteger(r))throw new Error(`${r} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return r}getInt64(t,e){let s=0;const i=(this._dataView.getUint8(t+(e?7:0))&128)>0;let r=!0;for(let a=0;a<8;a++){let o=this._dataView.getUint8(t+(e?a:7-a));i&&(r?o!==0&&(o=~(o-1)&255,r=!1):o=~o&255),s+=o*256**a}return i&&(s=-s),s}getUint8(t,e){return this._dataView.getUint8(t,e)}getInt8(t,e){return this._dataView.getInt8(t,e)}getUint16(t,e){return this._dataView.getUint16(t,e)}getInt16(t,e){return this._dataView.getInt16(t,e)}getUint32(t,e){return this._dataView.getUint32(t,e)}getInt32(t,e){return this._dataView.getInt32(t,e)}getFloat16(t,e){return yr(this._dataView,t,e)}getFloat32(t,e){return this._dataView.getFloat32(t,e)}getFloat64(t,e){return this._dataView.getFloat64(t,e)}}class Fh{constructor(t,e,s,i){this._dataView=new DataView(t),this._sliceOffset=e,this._littleEndian=s,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(t,e){return this.sliceOffset<=t&&this.sliceTop>=t+e}readUint8(t){return this._dataView.getUint8(t-this._sliceOffset,this._littleEndian)}readInt8(t){return this._dataView.getInt8(t-this._sliceOffset,this._littleEndian)}readUint16(t){return this._dataView.getUint16(t-this._sliceOffset,this._littleEndian)}readInt16(t){return this._dataView.getInt16(t-this._sliceOffset,this._littleEndian)}readUint32(t){return this._dataView.getUint32(t-this._sliceOffset,this._littleEndian)}readInt32(t){return this._dataView.getInt32(t-this._sliceOffset,this._littleEndian)}readFloat32(t){return this._dataView.getFloat32(t-this._sliceOffset,this._littleEndian)}readFloat64(t){return this._dataView.getFloat64(t-this._sliceOffset,this._littleEndian)}readUint64(t){const e=this.readUint32(t),s=this.readUint32(t+4);let i;if(this._littleEndian){if(i=e+2**32*s,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*e+s,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(t){let e=0;const s=(this._dataView.getUint8(t+(this._littleEndian?7:0))&128)>0;let i=!0;for(let r=0;r<8;r++){let a=this._dataView.getUint8(t+(this._littleEndian?r:7-r));s&&(i?a!==0&&(a=~(a-1)&255,i=!1):a=~a&255),e+=a*256**r}return s&&(e=-e),e}readOffset(t){return this._bigTiff?this.readUint64(t):this.readUint32(t)}}const un=`\r
\r
`;function xr(n){if(typeof Object.fromEntries<"u")return Object.fromEntries(n);const t={};for(const[e,s]of n)t[e.toLowerCase()]=s;return t}function Bh(n){const t=n.split(`\r
`).map(e=>{const s=e.split(":").map(i=>i.trim());return s[0]=s[0].toLowerCase(),s});return xr(t)}function qh(n){const[t,...e]=n.split(";").map(i=>i.trim()),s=e.map(i=>i.split("="));return{type:t,params:xr(s)}}function Fs(n){let t,e,s;return n&&([,t,e,s]=n.match(/bytes (\d+)-(\d+)\/(\d+)/),t=parseInt(t,10),e=parseInt(e,10),s=parseInt(s,10)),{start:t,end:e,total:s}}function Vh(n,t){let e=null;const s=new TextDecoder("ascii"),i=[],r=`--${t}`,a=`${r}--`;for(let o=0;o<10;++o)s.decode(new Uint8Array(n,o,r.length))===r&&(e=o);if(e===null)throw new Error("Could not find initial boundary");for(;e<n.byteLength;){const o=s.decode(new Uint8Array(n,e,Math.min(r.length+1024,n.byteLength-e)));if(o.length===0||o.startsWith(a))break;if(!o.startsWith(r))throw new Error("Part does not start with boundary");const h=o.substr(r.length+2);if(h.length===0)break;const l=h.indexOf(un),c=Bh(h.substr(0,l)),{start:u,end:d,total:f}=Fs(c["content-range"]),m=e+r.length+l+un.length,y=parseInt(d,10)+1-parseInt(u,10);i.push({headers:c,data:n.slice(m,m+y),offset:u,length:y,fileSize:f}),e=m+y+4}return i}class _r{async fetch(t,e=void 0){return Promise.all(t.map(s=>this.fetchSlice(s,e)))}async fetchSlice(t){throw new Error(`fetching of slice ${t} not possible, not implemented`)}get fileSize(){return null}async close(){}}class Gh extends Map{constructor(t={}){if(super(),!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||Number.POSITIVE_INFINITY,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if(typeof this.onEviction=="function")for(const[e,s]of t)this.onEviction(e,s.value)}_deleteIfExpired(t,e){return typeof e.expiry=="number"&&e.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(t,e.value),this.delete(t)):!1}_getOrDeleteIfExpired(t,e){if(this._deleteIfExpired(t,e)===!1)return e.value}_getItemValue(t,e){return e.expiry?this._getOrDeleteIfExpired(t,e):e.value}_peek(t,e){const s=e.get(t);return this._getItemValue(t,s)}_set(t,e){this.cache.set(t,e),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,e){this.oldCache.delete(t),this._set(t,e)}*_entriesAscending(){for(const t of this.oldCache){const[e,s]=t;this.cache.has(e)||this._deleteIfExpired(e,s)===!1&&(yield t)}for(const t of this.cache){const[e,s]=t;this._deleteIfExpired(e,s)===!1&&(yield t)}}get(t){if(this.cache.has(t)){const e=this.cache.get(t);return this._getItemValue(t,e)}if(this.oldCache.has(t)){const e=this.oldCache.get(t);if(this._deleteIfExpired(t,e)===!1)return this._moveToRecent(t,e),e.value}}set(t,e,{maxAge:s=this.maxAge}={}){const i=typeof s=="number"&&s!==Number.POSITIVE_INFINITY?Date.now()+s:void 0;return this.cache.has(t)?this.cache.set(t,{value:e,expiry:i}):this._set(t,{value:e,expiry:i}),this}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):this.oldCache.has(t)?!this._deleteIfExpired(t,this.oldCache.get(t)):!1}peek(t){if(this.cache.has(t))return this._peek(t,this.cache);if(this.oldCache.has(t))return this._peek(t,this.oldCache)}delete(t){const e=this.cache.delete(t);return e&&this._size--,this.oldCache.delete(t)||e}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const e=[...this._entriesAscending()],s=e.length-t;s<0?(this.cache=new Map(e),this.oldCache=new Map,this._size=e.length):(s>0&&this._emitEvictions(e.slice(0,s)),this.oldCache=new Map(e.slice(s)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of this.cache){const[e,s]=t;this._deleteIfExpired(e,s)===!1&&(yield[e,s.value])}for(const t of this.oldCache){const[e,s]=t;this.cache.has(e)||this._deleteIfExpired(e,s)===!1&&(yield[e,s.value])}}*entriesDescending(){let t=[...this.cache];for(let e=t.length-1;e>=0;--e){const s=t[e],[i,r]=s;this._deleteIfExpired(i,r)===!1&&(yield[i,r.value])}t=[...this.oldCache];for(let e=t.length-1;e>=0;--e){const s=t[e],[i,r]=s;this.cache.has(i)||this._deleteIfExpired(i,r)===!1&&(yield[i,r.value])}}*entriesAscending(){for(const[t,e]of this._entriesAscending())yield[t,e.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(const e of this.oldCache.keys())this.cache.has(e)||t++;return Math.min(this._size+t,this.maxSize)}entries(){return this.entriesAscending()}forEach(t,e=this){for(const[s,i]of this.entriesAscending())t.call(e,i,s,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function Yh(n){return new Promise(t=>setTimeout(t,n))}function $h(n,t){const e=Array.isArray(n)?n:Array.from(n),s=Array.isArray(t)?t:Array.from(t);return e.map((i,r)=>[i,s[r]])}class Wt extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,Wt),this.name="AbortError"}}class Xh extends Error{constructor(t,e){super(e),this.errors=t,this.message=e,this.name="AggregateError"}}const jh=Xh;class Hh{constructor(t,e,s=null){this.offset=t,this.length=e,this.data=s}get top(){return this.offset+this.length}}class fn{constructor(t,e,s){this.offset=t,this.length=e,this.blockIds=s}}class Zh extends _r{constructor(t,{blockSize:e=65536,cacheSize:s=100}={}){super(),this.source=t,this.blockSize=e,this.blockCache=new Gh({maxSize:s,onEviction:(i,r)=>{this.evictedBlocks.set(i,r)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(t,e){const s=[],i=[],r=[];this.evictedBlocks.clear();for(const{offset:d,length:f}of t){let m=d+f;const{fileSize:y}=this;y!==null&&(m=Math.min(m,y));const p=Math.floor(d/this.blockSize)*this.blockSize;for(let g=p;g<m;g+=this.blockSize){const x=Math.floor(g/this.blockSize);!this.blockCache.has(x)&&!this.blockRequests.has(x)&&(this.blockIdsToFetch.add(x),i.push(x)),this.blockRequests.has(x)&&s.push(this.blockRequests.get(x)),r.push(x)}}await Yh(),this.fetchBlocks(e);const a=[];for(const d of i)this.blockRequests.has(d)&&a.push(this.blockRequests.get(d));await Promise.allSettled(s),await Promise.allSettled(a);const o=[],h=r.filter(d=>this.abortedBlockIds.has(d)||!this.blockCache.has(d));if(h.forEach(d=>this.blockIdsToFetch.add(d)),h.length>0&&e&&!e.aborted){this.fetchBlocks(null);for(const d of h){const f=this.blockRequests.get(d);if(!f)throw new Error(`Block ${d} is not in the block requests`);o.push(f)}await Promise.allSettled(o)}if(e&&e.aborted)throw new Wt("Request was aborted");const l=r.map(d=>this.blockCache.get(d)||this.evictedBlocks.get(d)),c=l.filter(d=>!d);if(c.length)throw new jh(c,"Request failed");const u=new Map($h(r,l));return this.readSliceData(t,u)}fetchBlocks(t){if(this.blockIdsToFetch.size>0){const e=this.groupBlocks(this.blockIdsToFetch),s=this.source.fetch(e,t);for(let i=0;i<e.length;++i){const r=e[i];for(const a of r.blockIds)this.blockRequests.set(a,(async()=>{try{const o=(await s)[i],h=a*this.blockSize,l=h-o.offset,c=Math.min(l+this.blockSize,o.data.byteLength),u=o.data.slice(l,c),d=new Hh(h,u.byteLength,u,a);this.blockCache.set(a,d),this.abortedBlockIds.delete(a)}catch(o){if(o.name==="AbortError")o.signal=t,this.blockCache.delete(a),this.abortedBlockIds.add(a);else throw o}finally{this.blockRequests.delete(a)}})())}this.blockIdsToFetch.clear()}}groupBlocks(t){const e=Array.from(t).sort((a,o)=>a-o);if(e.length===0)return[];let s=[],i=null;const r=[];for(const a of e)i===null||i+1===a?(s.push(a),i=a):(r.push(new fn(s[0]*this.blockSize,s.length*this.blockSize,s)),s=[a],i=a);return r.push(new fn(s[0]*this.blockSize,s.length*this.blockSize,s)),r}readSliceData(t,e){return t.map(s=>{let i=s.offset+s.length;this.fileSize!==null&&(i=Math.min(this.fileSize,i));const r=Math.floor(s.offset/this.blockSize),a=Math.floor(i/this.blockSize),o=new ArrayBuffer(s.length),h=new Uint8Array(o);for(let l=r;l<=a;++l){const c=e.get(l),u=c.offset-s.offset,d=c.top-i;let f=0,m=0,y;u<0?f=-u:u>0&&(m=u),d<0?y=c.length-f:y=i-c.offset-f;const p=new Uint8Array(c.data,f,y);h.set(p,m)}return o})}}class hi{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(t){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class li{constructor(t){this.url=t}async request({headers:t,signal:e}={}){throw new Error("request is not implemented")}}class Kh extends hi{constructor(t){super(),this.response=t}get status(){return this.response.status}getHeader(t){return this.response.headers.get(t)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Wh extends li{constructor(t,e){super(t),this.credentials=e}async request({headers:t,signal:e}={}){const s=await fetch(this.url,{headers:t,credentials:this.credentials,signal:e});return new Kh(s)}}class Jh extends hi{constructor(t,e){super(),this.xhr=t,this.data=e}get status(){return this.xhr.status}getHeader(t){return this.xhr.getResponseHeader(t)}async getData(){return this.data}}class Qh extends li{constructRequest(t,e){return new Promise((s,i)=>{const r=new XMLHttpRequest;r.open("GET",this.url),r.responseType="arraybuffer";for(const[a,o]of Object.entries(t))r.setRequestHeader(a,o);r.onload=()=>{const a=r.response;s(new Jh(r,a))},r.onerror=i,r.onabort=()=>i(new Wt("Request aborted")),r.send(),e&&(e.aborted&&r.abort(),e.addEventListener("abort",()=>r.abort()))})}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}var zs={};class tl extends hi{constructor(t,e){super(),this.response=t,this.dataPromise=e}get status(){return this.response.statusCode}getHeader(t){return this.response.headers[t]}async getData(){return await this.dataPromise}}class el extends li{constructor(t){super(t),this.parsedUrl=zs.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",zs)}constructRequest(t,e){return new Promise((s,i)=>{const r=this.httpApi.get({...this.parsedUrl,headers:t},a=>{const o=new Promise(h=>{const l=[];a.on("data",c=>{l.push(c)}),a.on("end",()=>{const c=Buffer.concat(l).buffer;h(c)}),a.on("error",i)});s(new tl(a,o))});r.on("error",i),e&&(e.aborted&&r.destroy(new Wt("Request aborted")),e.addEventListener("abort",()=>r.destroy(new Wt("Request aborted"))))})}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}class ci extends _r{constructor(t,e,s,i){super(),this.client=t,this.headers=e,this.maxRanges=s,this.allowFullFile=i,this._fileSize=null}async fetch(t,e){return this.maxRanges>=t.length?this.fetchSlices(t,e):(this.maxRanges>0&&t.length>1,Promise.all(t.map(s=>this.fetchSlice(s,e))))}async fetchSlices(t,e){const s=await this.client.request({headers:{...this.headers,Range:`bytes=${t.map(({offset:i,length:r})=>`${i}-${i+r}`).join(",")}`},signal:e});if(s.ok)if(s.status===206){const{type:i,params:r}=qh(s.getHeader("content-type"));if(i==="multipart/byteranges"){const u=Vh(await s.getData(),r.boundary);return this._fileSize=u[0].fileSize||null,u}const a=await s.getData(),{start:o,end:h,total:l}=Fs(s.getHeader("content-range"));this._fileSize=l||null;const c=[{data:a,offset:o,length:h-o}];if(t.length>1){const u=await Promise.all(t.slice(1).map(d=>this.fetchSlice(d,e)));return c.concat(u)}return c}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const i=await s.getData();return this._fileSize=i.byteLength,[{data:i,offset:0,length:i.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(t,e){const{offset:s,length:i}=t,r=await this.client.request({headers:{...this.headers,Range:`bytes=${s}-${s+i}`},signal:e});if(r.ok)if(r.status===206){const a=await r.getData(),{total:o}=Fs(r.getHeader("content-range"));return this._fileSize=o||null,{data:a,offset:s,length:i}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const a=await r.getData();return this._fileSize=a.byteLength,{data:a,offset:0,length:a.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function ui(n,{blockSize:t,cacheSize:e}){return t===null?n:new Zh(n,{blockSize:t,cacheSize:e})}function sl(n,{headers:t={},credentials:e,maxRanges:s=0,allowFullFile:i=!1,...r}={}){const a=new Wh(n,e),o=new ci(a,t,s,i);return ui(o,r)}function il(n,{headers:t={},maxRanges:e=0,allowFullFile:s=!1,...i}={}){const r=new Qh(n),a=new ci(r,t,e,s);return ui(a,i)}function nl(n,{headers:t={},maxRanges:e=0,allowFullFile:s=!1,...i}={}){const r=new el(n),a=new ci(r,t,e,s);return ui(a,i)}function rl(n,{forceXHR:t=!1,...e}={}){return typeof fetch=="function"&&!t?sl(n,e):typeof XMLHttpRequest<"u"?il(n,e):nl(n,e)}function Bs(n){switch(n){case E.BYTE:case E.ASCII:case E.SBYTE:case E.UNDEFINED:return 1;case E.SHORT:case E.SSHORT:return 2;case E.LONG:case E.SLONG:case E.FLOAT:case E.IFD:return 4;case E.RATIONAL:case E.SRATIONAL:case E.DOUBLE:case E.LONG8:case E.SLONG8:case E.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${n}`)}}function al(n){const t=n.GeoKeyDirectory;if(!t)return null;const e={};for(let s=4;s<=t[3]*4;s+=4){const i=gh[t[s]],r=t[s+1]?he[t[s+1]]:null,a=t[s+2],o=t[s+3];let h=null;if(!r)h=o;else{if(h=n[r],typeof h>"u"||h===null)throw new Error(`Could not get value of geoKey '${i}'.`);typeof h=="string"?h=h.substring(o,o+a-1):h.subarray&&(h=h.subarray(o,o+a),a===1&&(h=h[0]))}e[i]=h}return e}function Ft(n,t,e,s){let i=null,r=null;const a=Bs(t);switch(t){case E.BYTE:case E.ASCII:case E.UNDEFINED:i=new Uint8Array(e),r=n.readUint8;break;case E.SBYTE:i=new Int8Array(e),r=n.readInt8;break;case E.SHORT:i=new Uint16Array(e),r=n.readUint16;break;case E.SSHORT:i=new Int16Array(e),r=n.readInt16;break;case E.LONG:case E.IFD:i=new Uint32Array(e),r=n.readUint32;break;case E.SLONG:i=new Int32Array(e),r=n.readInt32;break;case E.LONG8:case E.IFD8:i=new Array(e),r=n.readUint64;break;case E.SLONG8:i=new Array(e),r=n.readInt64;break;case E.RATIONAL:i=new Uint32Array(e*2),r=n.readUint32;break;case E.SRATIONAL:i=new Int32Array(e*2),r=n.readInt32;break;case E.FLOAT:i=new Float32Array(e),r=n.readFloat32;break;case E.DOUBLE:i=new Float64Array(e),r=n.readFloat64;break;default:throw new RangeError(`Invalid field type: ${t}`)}if(t===E.RATIONAL||t===E.SRATIONAL)for(let o=0;o<e;o+=2)i[o]=r.call(n,s+o*a),i[o+1]=r.call(n,s+(o*a+4));else for(let o=0;o<e;++o)i[o]=r.call(n,s+o*a);return t===E.ASCII?new TextDecoder("utf-8").decode(i):i}class ol{constructor(t,e,s){this.fileDirectory=t,this.geoKeyDirectory=e,this.nextIFDByteOffset=s}}class Xe extends Error{constructor(t){super(`No image at index ${t}`),this.index=t}}class hl{async readRasters(t={}){const{window:e,width:s,height:i}=t;let{resX:r,resY:a,bbox:o}=t;const h=await this.getImage();let l=h;const c=await this.getImageCount(),u=h.getBoundingBox();if(e&&o)throw new Error('Both "bbox" and "window" passed.');if(s||i){if(e){const[m,y]=h.getOrigin(),[p,g]=h.getResolution();o=[m+e[0]*p,y+e[1]*g,m+e[2]*p,y+e[3]*g]}const f=o||u;if(s){if(r)throw new Error("Both width and resX passed");r=(f[2]-f[0])/s}if(i){if(a)throw new Error("Both width and resY passed");a=(f[3]-f[1])/i}}if(r||a){const f=[];for(let m=0;m<c;++m){const y=await this.getImage(m),{SubfileType:p,NewSubfileType:g}=y.fileDirectory;(m===0||p===2||g&1)&&f.push(y)}f.sort((m,y)=>m.getWidth()-y.getWidth());for(let m=0;m<f.length;++m){const y=f[m],p=(u[2]-u[0])/y.getWidth(),g=(u[3]-u[1])/y.getHeight();if(l=y,r&&r>p||a&&a>g)break}}let d=e;if(o){const[f,m]=h.getOrigin(),[y,p]=l.getResolution(h);d=[Math.round((o[0]-f)/y),Math.round((o[1]-m)/p),Math.round((o[2]-f)/y),Math.round((o[3]-m)/p)],d=[Math.min(d[0],d[2]),Math.min(d[1],d[3]),Math.max(d[0],d[2]),Math.max(d[1],d[3])]}return l.readRasters({...t,window:d})}}class fi extends hl{constructor(t,e,s,i,r={}){super(),this.source=t,this.littleEndian=e,this.bigTiff=s,this.firstIFDOffset=i,this.cache=r.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(t,e){const s=this.bigTiff?4048:1024;return new Fh((await this.source.fetch([{offset:t,length:typeof e<"u"?e:s}]))[0],t,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(t){const e=this.bigTiff?20:12,s=this.bigTiff?8:2;let i=await this.getSlice(t);const r=this.bigTiff?i.readUint64(t):i.readUint16(t),a=r*e+(this.bigTiff?16:6);i.covers(t,a)||(i=await this.getSlice(t,a));const o={};let h=t+(this.bigTiff?8:2);for(let u=0;u<r;h+=e,++u){const d=i.readUint16(h),f=i.readUint16(h+2),m=this.bigTiff?i.readUint64(h+4):i.readUint32(h+4);let y,p;const g=Bs(f),x=h+(this.bigTiff?12:8);if(g*m<=(this.bigTiff?8:4))y=Ft(i,f,m,x);else{const _=i.readOffset(x),S=Bs(f)*m;if(i.covers(_,S))y=Ft(i,f,m,_);else{const w=await this.getSlice(_,S);y=Ft(w,f,m,_)}}m===1&&yh.indexOf(d)===-1&&!(f===E.RATIONAL||f===E.SRATIONAL)?p=y[0]:p=y,o[he[d]]=p}const l=al(o),c=i.readOffset(t+s+e*r);return new ol(o,l,c)}async requestIFD(t){if(this.ifdRequests[t])return this.ifdRequests[t];if(t===0)return this.ifdRequests[t]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[t];if(!this.ifdRequests[t-1])try{this.ifdRequests[t-1]=this.requestIFD(t-1)}catch(e){throw e instanceof Xe?new Xe(t):e}return this.ifdRequests[t]=(async()=>{const e=await this.ifdRequests[t-1];if(e.nextIFDByteOffset===0)throw new Xe(t);return this.parseFileDirectoryAt(e.nextIFDByteOffset)})(),this.ifdRequests[t]}async getImage(t=0){const e=await this.requestIFD(t);return new Nh(e.fileDirectory,e.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let t=0,e=!0;for(;e;)try{await this.requestIFD(t),++t}catch(s){if(s instanceof Xe)e=!1;else throw s}return t}async getGhostValues(){const t=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const e="GDAL_STRUCTURAL_METADATA_SIZE=",s=e.length+100;let i=await this.getSlice(t,s);if(e===Ft(i,E.ASCII,e.length,t)){const a=Ft(i,E.ASCII,s,t).split(`
`)[0],o=Number(a.split("=")[1].split(" ")[0])+a.length;o>s&&(i=await this.getSlice(t,o));const h=Ft(i,E.ASCII,o,t);this.ghostValues={},h.split(`
`).filter(l=>l.length>0).map(l=>l.split("=")).forEach(([l,c])=>{this.ghostValues[l]=c})}return this.ghostValues}static async fromSource(t,e,s){const i=(await t.fetch([{offset:0,length:1024}],s))[0],r=new Uh(i),a=r.getUint16(0,0);let o;if(a===18761)o=!0;else if(a===19789)o=!1;else throw new TypeError("Invalid byte order value.");const h=r.getUint16(2,o);let l;if(h===42)l=!1;else if(h===43){if(l=!0,r.getUint16(4,o)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const c=l?r.getUint64(8,o):r.getUint32(4,o);return new fi(t,o,l,c,e)}close(){return typeof this.source.close=="function"?this.source.close():!1}}async function ll(n,t={},e){return fi.fromSource(rl(n,t),e)}function cl(n){const t=/[\u0000]$/g;return n.trim().replace(t,"").trim()}function ul(n){const t=new DOMParser;try{return t.parseFromString(n,"text/xml").getElementsByTagName("OME")[0]}catch(e){throw new B("Could not find OME metadata in TIFF file",{type:P.INVALID_METADATA,cause:e})}}class fl{constructor(){this.sizex=0,this.sizey=0,this.sizez=1,this.sizec=1,this.sizet=1,this.unit="",this.pixeltype="",this.dimensionorder="",this.pixelsizex=1,this.pixelsizey=1,this.pixelsizez=1,this.channelnames=[]}}function dn(n){const e={uint8:"uint8",uint16:"uint16",uint32:"uint32",int8:"int8",int16:"int16",int32:"int32",float:"float32"}[n];return e===void 0?(console.warn(`Unsupported OME pixel type ${n}; defaulting to uint8`),"uint8"):e}function mn(n,t){const e=n.getAttribute(t);if(e===null)throw new B(`Missing attribute ${t} in OME-TIFF metadata`,{type:P.INVALID_METADATA});return e}function dl(n){const t=new fl,e=n.getElementsByTagName("Pixels")[0];t.sizex=Number(mn(e,"SizeX")),t.sizey=Number(mn(e,"SizeY")),t.sizez=Number(e.getAttribute("SizeZ")),t.sizec=Number(e.getAttribute("SizeC")),t.sizet=Number(e.getAttribute("SizeT")),t.unit=e.getAttribute("PhysicalSizeXUnit")||"",t.pixeltype=e.getAttribute("Type")||"",t.dimensionorder=e.getAttribute("DimensionOrder")||"XYZCT",t.pixelsizex=Number(e.getAttribute("PhysicalSizeX")),t.pixelsizey=Number(e.getAttribute("PhysicalSizeY")),t.pixelsizez=Number(e.getAttribute("PhysicalSizeZ"));const s=e.getElementsByTagName("Channel");for(let i=0;i<s.length;++i){const r=s[i].getAttribute("Name"),a=s[i].getAttribute("ID");t.channelnames.push(r||a||"Channel"+i)}return t}const ml=n=>n==="uint8"?1:n==="uint16"?2:4;class yl extends rs{constructor(t){super(),this.url=t}async loadOmeDims(){if(!this.dims){const e=await(await ll(this.url,{allowFullFile:!0}).catch(Yt(`Could not open TIFF file at ${this.url}`,P.NOT_FOUND))).getImage().catch(Yt("Failed to open TIFF image",P.NOT_FOUND)),s=cl(e.getFileDirectory().ImageDescription),r=ul(s).getElementsByTagName("Image")[0];this.dims=dl(r)}return this.dims}async loadDims(t){const e=await this.loadOmeDims(),s=ce(e.sizez,e.sizex,e.sizey),i=le,r=Math.floor(i/s.x),a=Math.floor(i/s.y);return[{shape:[e.sizet,e.sizec,e.sizez,a,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/a,e.pixelsizex*e.sizex/r],spaceUnit:e.unit?e.unit:"micron",dataType:dn(e.pixeltype),timeUnit:"s"}]}async createImageInfo(t){const e=await this.loadOmeDims(),s=ce(e.sizez,e.sizex,e.sizey),i=le,r=Math.floor(i/s.x),a=Math.floor(i/s.y);return{imageInfo:{name:"TEST",atlasTileDims:[s.x,s.y],subregionSize:[r,a,e.sizez],subregionOffset:[0,0,0],combinedNumChannels:e.sizec,channelNames:e.channelnames,multiscaleLevel:0,multiscaleLevelDims:[{shape:[e.sizet,e.sizec,e.sizez,a,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/a,e.pixelsizex*e.sizex/r],spaceUnit:e.unit||"",timeUnit:"",dataType:dn(e.pixeltype)}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},loadSpec:new Wn}}async loadRawChannelData(t,e,s,i){const r=await this.loadOmeDims(),o=new ns(t).volumeSize,h=[];for(let l=0;l<t.combinedNumChannels;++l){const c=new Promise((u,d)=>{const f={channel:l,tilesizex:o.x,tilesizey:o.y,sizec:t.combinedNumChannels,sizez:o.z,dimensionOrder:r.dimensionorder,bytesPerSample:ml(r.pixeltype),url:this.url},m=new Worker(new URL("/assets/FetchTiffWorker-CGY6XB2t.js",import.meta.url),{type:"module"});m.onmessage=y=>{if(y.data.isError){d(Or(y.data.error));return}const{data:p,dtype:g,channel:x,range:_}=y.data;i([x],[g],[p],[_]),m.terminate(),u()},m.postMessage(f)});h.push(c)}await Promise.all(h)}}var wr=(n=>(n.ZARR="zarr",n.JSON="json",n.TIFF="tiff",n.DATA="data",n))(wr||{});function br(n){return n.endsWith(".json")?"json":n.endsWith(".tif")||n.endsWith(".tiff")?"tiff":"zarr"}async function pl(n,t){const e=Array.isArray(n)?n[0]:n;switch((t==null?void 0:t.fileType)||br(e)){case"zarr":return await ei.createLoader(n,t==null?void 0:t.scene,t==null?void 0:t.cache,t==null?void 0:t.queue,t==null?void 0:t.fetchOptions);case"json":return new si(n,t==null?void 0:t.cache);case"tiff":return new yl(e);case"data":if(!(t!=null&&t.rawArrayOptions))throw new Error("Must provide RawArrayOptions for RawArrayLoader");return new Po(t==null?void 0:t.rawArrayOptions.data,t==null?void 0:t.rawArrayOptions.metadata)}}var et=(n=>(n[n.INIT=0]="INIT",n[n.CREATE_LOADER=1]="CREATE_LOADER",n[n.CLOSE_LOADER=2]="CLOSE_LOADER",n[n.CREATE_VOLUME=3]="CREATE_VOLUME",n[n.LOAD_DIMS=4]="LOAD_DIMS",n[n.LOAD_VOLUME_DATA=5]="LOAD_VOLUME_DATA",n[n.SET_PREFETCH_PRIORITY_DIRECTIONS=6]="SET_PREFETCH_PRIORITY_DIRECTIONS",n[n.SYNCHRONIZE_MULTICHANNEL_LOADING=7]="SYNCHRONIZE_MULTICHANNEL_LOADING",n[n.UPDATE_FETCH_OPTIONS=8]="UPDATE_FETCH_OPTIONS",n))(et||{}),fe=(n=>(n[n.SUCCESS=0]="SUCCESS",n[n.ERROR=1]="ERROR",n[n.EVENT=2]="EVENT",n))(fe||{}),qs=(n=>(n[n.METADATA_UPDATE=0]="METADATA_UPDATE",n[n.CHANNEL_LOAD=1]="CHANNEL_LOAD",n))(qs||{});function Es(n){return{...n,subregion:new it(new b().copy(n.subregion.min),new b().copy(n.subregion.max))}}let yn,pn,gn,xn=0;const Vs=new Map,Bt=n=>{const t=Vs.get(n);if(t===void 0)throw new B(`Loader with ID ${n} does not exist`);return t};let _n=!1;const gl={[et.INIT]:({maxCacheSize:n,maxActiveRequests:t,maxLowPriorityRequests:e})=>(_n||(yn=new Nr(n),pn=new Xn(t,e),gn=new jn(pn),_n=!0),Promise.resolve()),[et.CREATE_LOADER]:async({path:n,options:t})=>{const e=await pl(n,{...t,cache:yn,queue:gn});if(e===void 0)return;const s=Array.isArray(n)?n[0]:n,r=((t==null?void 0:t.fileType)||br(s))===wr.JSON,a=xn;return xn+=1,Vs.set(a,{loader:e,copyOnLoad:r}),a},[et.CLOSE_LOADER]:(n,t)=>(Vs.delete(t),Promise.resolve()),[et.CREATE_VOLUME]:async(n,t)=>{const{loader:e}=Bt(t);return await e.createImageInfo(Es(n))},[et.LOAD_DIMS]:async(n,t)=>{const{loader:e}=Bt(t);return await e.loadDims(Es(n))},[et.LOAD_VOLUME_DATA]:({imageInfo:n,loadSpec:t,loadId:e},s)=>{const{loader:i,copyOnLoad:r}=Bt(s);return i.loadRawChannelData(n,Es(t),(a,o)=>{const h={responseResult:fe.EVENT,eventType:qs.METADATA_UPDATE,loaderId:s,loadId:e,imageInfo:a,loadSpec:o};self.postMessage(h)},(a,o,h,l,c)=>{const u={responseResult:fe.EVENT,eventType:qs.CHANNEL_LOAD,loaderId:s,loadId:e,channelIndex:a,dtype:o,data:h,ranges:l,atlasDims:c};self.postMessage(u,r?[]:h.map(d=>d.buffer))})},[et.SET_PREFETCH_PRIORITY_DIRECTIONS]:(n,t)=>{const{loader:e}=Bt(t);return e==null||e.setPrefetchPriority(n),Promise.resolve()},[et.SYNCHRONIZE_MULTICHANNEL_LOADING]:(n,t)=>{const{loader:e}=Bt(t);return e==null||e.syncMultichannelLoading(n),Promise.resolve()},[et.UPDATE_FETCH_OPTIONS]:(n,t)=>{const{loader:e}=Bt(t);return e==null||e.updateFetchOptions(n),Promise.resolve()}};self.onmessage=async({data:n})=>{let t;try{const e=await gl[n.type](n.payload,n.loaderId);t={...n,responseResult:fe.SUCCESS,payload:e}}catch(e){t={...n,responseResult:fe.ERROR,payload:Rr(e)}}self.postMessage(t)};export{wl as L,bl as a,pr as g};
